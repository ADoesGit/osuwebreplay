var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol?"symbol":typeof obj};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var DEBUG=true;var APIURL="/api/";if(DEBUG){APIURL="http://ugrend.com:8080/api/"}function Uint8ToString(u8a){var CHUNK_SZ=32768;var c=[];for(var i=0;i<u8a.length;i+=CHUNK_SZ){c.push(String.fromCharCode.apply(null,u8a.subarray(i,i+CHUNK_SZ)))}return c.join("")}var mainArea=document.getElementById("main_zone");var dragDropZone=document.getElementById("dragdrop");var dragDropLabel=document.getElementById("drag_label");var replay="";var beatmap=null;zip.workerScriptsPath="static/libs/js/";if(!Uint8Array.prototype.slice&&"subarray"in Uint8Array.prototype)Uint8Array.prototype.slice=Uint8Array.prototype.subarray;if(!Element.prototype.scrollIntoViewIfNeeded){Element.prototype.scrollIntoViewIfNeeded=function(centerIfNeeded){centerIfNeeded=arguments.length===0?true:!!centerIfNeeded;var parent=this.parentNode,parentComputedStyle=window.getComputedStyle(parent,null),parentBorderTopWidth=parseInt(parentComputedStyle.getPropertyValue("border-top-width")),parentBorderLeftWidth=parseInt(parentComputedStyle.getPropertyValue("border-left-width")),overTop=this.offsetTop-parent.offsetTop<parent.scrollTop,overBottom=this.offsetTop-parent.offsetTop+this.clientHeight-parentBorderTopWidth>parent.scrollTop+parent.clientHeight,overLeft=this.offsetLeft-parent.offsetLeft<parent.scrollLeft,overRight=this.offsetLeft-parent.offsetLeft+this.clientWidth-parentBorderLeftWidth>parent.scrollLeft+parent.clientWidth,alignWithTop=overTop&&!overBottom;if((overTop||overBottom)&&centerIfNeeded){parent.scrollTop=this.offsetTop-parent.offsetTop-parent.clientHeight/2-parentBorderTopWidth+this.clientHeight/2}if((overLeft||overRight)&&centerIfNeeded){parent.scrollLeft=this.offsetLeft-parent.offsetLeft-parent.clientWidth/2-parentBorderLeftWidth+this.clientWidth/2}if((overTop||overBottom||overLeft||overRight)&&!centerIfNeeded){this.scrollIntoView(alignWithTop)}}}var osu=osu||{};osu.skins={COMBO_COLOURS:[],DEFAULT_COLOURS:[16760832,51712,1211647,15865913],loaded:false,resources:{},DEFAULT_RESOURCES:[{name:"hit300",url:"resources/hit300.png"},{name:"hit300g",url:"resources/hit300g.png"},{name:"hit300k",url:"resources/hit300k.png"},{name:"hit100",url:"resources/hit100.png"},{name:"hit100k",url:"resources/hit100k.png"},{name:"hit50",url:"resources/hit50.png"},{name:"hit0",url:"resources/hit0.png"},{name:"ranking_xh",url:"resources/ranking-XH.png"},{name:"ranking_sh",url:"resources/ranking-SH.png"},{name:"ranking_x",url:"resources/ranking-X.png"},{name:"ranking_s",url:"resources/ranking-S.png"},{name:"ranking_a",url:"resources/ranking-A.png"},{name:"ranking_b",url:"resources/ranking-B.png"},{name:"ranking_c",url:"resources/ranking-C.png"},{name:"ranking_d",url:"resources/ranking-D.png"},{name:"ranking_xh_small",url:"resources/ranking-XH.png"},{name:"ranking_sh_small",url:"resources/ranking-SH.png"},{name:"ranking_x_small",url:"resources/ranking-X.png"},{name:"ranking_s_small",url:"resources/ranking-S.png"},{name:"ranking_a_small",url:"resources/ranking-A.png"},{name:"ranking_b_small",url:"resources/ranking-B.png"},{name:"ranking_c_small",url:"resources/ranking-C.png"},{name:"ranking_d_small",url:"resources/ranking-D.png"},{name:"pause_replay",url:"resources/pause-replay.png"},{name:"menu_back",url:"resources/menu-back.png"},{name:"cursor",url:"resources/cursor.png"},{name:"cursortrail",url:"resources/cursortrail.png"},{name:"cursormiddle",url:"resources/cursormiddle.png"},{name:"cursor_smoke",url:"resources/cursor-smoke.png"},{name:"inputoverlay_key",url:"resources/inputoverlay-key.png"},{name:"star",url:"resources/star.png"},{name:"section_fail",url:"resources/section-fail.png"},{name:"section_pass",url:"resources/section-pass.png"},{name:"play_warningarrow",url:"resources/play-warningarrow.png"},{name:"play_skip",url:"resources/play-skip.png"},{name:"hitcircle",url:"resources/hitcircle.png"},{name:"hitcicleoverlay",url:"resources/hitcircleoverlay.png"},{name:"approachcircle",url:"resources/approachcircle.png"},{name:"followpoint",url:"resources/followpoint.png"},{name:"sliderfollowcircle",url:"resources/sliderfollowcircle.png"},{name:"reversearrow",url:"resources/reversearrow.png"},{name:"sliderscorepoint",url:"resources/sliderscorepoint.png"},{name:"sliderb0",url:"resources/sliderb0.png"},{name:"spinner_approachcircle",url:"resources/spinner-approachcircle.png"},{name:"spinner_background",url:"resources/spinner-background.png"},{name:"spinner_bottom",url:"resources/spinner-bottom.png"},{name:"spinner_circle",url:"resources/spinner-circle.png"},{name:"spinner_clear",url:"resources/spinner-clear.png"},{name:"spinner_glow",url:"resources/spinner-glow.png"},{name:"spinner_metre",url:"resources/spinner-metre.png"},{name:"spinner_middle",url:"resources/spinner-middle.png"},{name:"spinner_middle2",url:"resources/spinner-middle2.png"},{name:"spinner_osu",url:"resources/spinner-osu.png"},{name:"spinner_rpm",url:"resources/spinner-rpm.png"},{name:"spinner_spin",url:"resources/spinner-spin.png"},{name:"spinner_top",url:"resources/spinner-top.png"},{name:"spinner_warning",url:"resources/spinner-warning.png"},{name:"default_0",url:"resources/default-0.png"},{name:"default_1",url:"resources/default-1.png"},{name:"default_2",url:"resources/default-2.png"},{name:"default_3",url:"resources/default-3.png"},{name:"default_4",url:"resources/default-4.png"},{name:"default_5",url:"resources/default-5.png"},{name:"default_6",url:"resources/default-6.png"},{name:"default_7",url:"resources/default-7.png"},{name:"default_8",url:"resources/default-8.png"},{name:"default_9",url:"resources/default-9.png"},{name:"selection_mod_doubletime",url:"resources/selection-mod-doubletime.png"},{name:"selection_mod_easy",url:"resources/selection-mod-easy.png"},{name:"selection_mod_flashlight",url:"resources/selection-mod-flashlight.png"},{name:"selection_mod_halftime",url:"resources/selection-mod-halftime.png"},{name:"selection_mod_hardrock",url:"resources/selection-mod-hardrock.png"},{name:"selection_mod_hidden",url:"resources/selection-mod-hidden.png"},{name:"selection_mod_nightcore",url:"resources/selection-mod-nightcore.png"},{name:"selection_mod_nofail",url:"resources/selection-mod-nofail.png"},{name:"selection_mod_perfect",url:"resources/selection-mod-perfect.png"},{name:"selection_mod_spunout",url:"resources/selection-mod-spunout.png"},{name:"selection_mod_suddendeath",url:"resources/selection-mod-suddendeath.png"},{name:"pause_overlay",url:"resources/pause-overlay.png"},{name:"pause_continue",url:"resources/pause-continue.png"},{name:"pause_back",url:"resources/pause-back.png"}],skins:[],init:function init(){var self=this;this.skins=[];database.getAll("skins",function(result){for(var i=0;i<result.length;i++){self.skins.push({md5sum:result[i].md5sum,name:result[i].name})}var current_skin={};self.COMBO_COLOURS=[];for(i=0;i<self.DEFAULT_RESOURCES.length;i++){current_skin[self.DEFAULT_RESOURCES[i].name]=self.DEFAULT_RESOURCES[i].url}if(osu.settings.SETTINGS.selected_skin!="0"){database.get_data(database.TABLES.SKINS,osu.settings.SETTINGS.selected_skin,function(data){if(data.data.colours){for(i=0;i<data.data.colours.length;i++){self.COMBO_COLOURS.push(data.data.colours[i])}}self._loadAssetsFromIDB(current_skin,data.data.assets,self.loadSkin.bind(self))})}else{for(i=0;i<self.DEFAULT_COLOURS.length;i++){self.COMBO_COLOURS.push(self.DEFAULT_COLOURS[i])}self.loadSkin(current_skin)}})},_loadAssetsFromIDB:function _loadAssetsFromIDB(current_skin,assets,cb){var _length=assets.length;var _loaded=0;for(var i=0;i<_length;i++){var fileExt=assets[i].filename.split(".").pop();var name=assets[i].filename.split(".")[0].toLowerCase().replace(/-|@/g,"_");if(fileExt.toLowerCase()=="png"){(function(name){database.get_data(database.TABLES.ASSETS,assets[i].md5sum,function(result){_loaded++;current_skin[name]=result.data;if(_loaded>=_length){cb(current_skin)}},function(){_loaded++;if(_loaded>=_length){cb(current_skin)}})})(name)}else if(fileExt.toLowerCase()=="wav"||fileExt.toLowerCase()=="mp3"){(function(name){database.get_data(database.TABLES.ASSETS,assets[i].md5sum,function(result){_loaded++;osu.skins.audio[name]=result.data;if(_loaded>=_length){cb(current_skin)}},function(){_loaded++;if(_loaded>=_length){cb(current_skin)}})})(name)}else{_loaded++;if(_loaded>=_length){cb(current_skin)}}}if(_loaded>=_length){cb(current_skin)}},loadSkin:function loadSkin(skin){var self=this;var skinArray=[];for(var k in skin){if(skin.hasOwnProperty(k)){skinArray.push({name:k,url:skin[k]})}}var loader=new PIXI.loaders.Loader;loader.add(skinArray).on("progress",self.loadProgressHandler.bind(self)).load(self._loaded.bind(self))},loadProgressHandler:function loadProgressHandler(loader,resources){if(resources.name=="ranking-sh"){console.log(resources)}},onloaded:function onloaded(){},_loaded:function _loaded(loader,resources){this.resources=resources;event_handler.emit(event_handler.EVENTS.RESOURCES_LOADED);this.loaded=true;osu.skins.onloaded();osu.audio.sound.init();osu.skins.onloaded=function(){}},audio:{applause:"resources/applause.wav",combobreak:"resources/combobreak.wav",count1s:"resources/count1s.wav",count2s:"resources/count2s.wav",count3s:"resources/count3s.wav",drum_hitclap:"resources/drum-hitclap.wav",drum_hitfinish:"resources/drum-hitfinish.wav",drum_hitfinish2:"resources/drum-hitfinish2.wav",drum_hitnormal:"resources/drum-hitnormal.wav",drum_hitnormal19:"resources/drum-hitnormal19.wav",drum_hitnormal2:"resources/drum-hitnormal2.wav",drum_hitwhistle:"resources/drum-hitwhistle.wav",drum_sliderslide:"resources/drum-sliderslide.wav",drum_slidertick:"resources/drum-slidertick.wav",drum_sliderwhistle:"resources/drum-sliderwhistle.wav",failsound:"resources/failsound.wav",gos:"resources/gos.wav",menuback:"resources/menuback.wav",menuclick:"resources/menuclick.wav",menuhit:"resources/menuhit.wav",normal_hitclap:"resources/normal-hitclap.wav",normal_hitfinish:"resources/normal-hitfinish.wav",normal_hitnormal:"resources/normal-hitnormal.wav",normal_hitwhistle:"resources/normal-hitwhistle.wav",normal_sliderslide:"resources/normal-sliderslide.wav",normal_slidertick:"resources/normal-slidertick.wav",normal_sliderwhistle:"resources/normal-sliderwhistle.wav",readys:"resources/readys.wav",sectionfail:"resources/sectionfail.wav",sectionpass:"resources/sectionpass.wav",shutter:"resources/shutter.wav",soft_hitclap:"resources/soft-hitclap.wav",soft_hitclap19:"resources/soft-hitclap19.wav",soft_hitfinish:"resources/soft-hitfinish.wav",soft_hitnormal:"resources/soft-hitnormal.wav",soft_hitwhistle:"resources/soft-hitwhistle.wav",soft_sliderslide:"resources/soft-sliderslide.wav",soft_sliderslide2:"resources/soft-sliderslide2.wav",soft_slidertick:"resources/soft-slidertick.wav",soft_sliderwhistle:"resources/soft-sliderwhistle.wav",spinnerbonus:"resources/spinnerbonus.wav",spinner_osu:"resources/spinner-osu.wav",spinnerspin:"resources/spinnerspin.wav"}};function loadBeatMap(){database.get_data(database.TABLES.BEATMAPS,replay.bmMd5Hash,function(e){if(typeof e.data!="undefined"){osu.beatmaps.BeatmapLoader.load(replay.bmMd5Hash,showReplayData)}else{var loading=new PNotify({title:"Downloading Beatmap",text:"Loading \n"+replay.bmMd5Hash,type:"info",hide:false});osu.webapi.beatmaps.loadBeatMap(replay.bmMd5Hash,function(e){loading.remove();osu.beatmaps.BeatmapLoader.load(replay.bmMd5Hash,showReplayData)})}})}function showReplayData(beatmap){osu.ui.interface.mainscreen.hide_main_screen();osu.ui.interface.scorescreen.mods=replay.mods;beatmap.been_rendered=false;osu.ui.interface.scorescreen.beatmap=beatmap;osu.ui.interface.scorescreen.played_by=replay.playerName;osu.ui.interface.scorescreen.date_played=replay.time_played;osu.ui.interface.scorescreen.total_score=replay.tScore;osu.ui.interface.scorescreen.t300Hits=replay.h300;osu.ui.interface.scorescreen.t300gHits=replay.hGekis;osu.ui.interface.scorescreen.t100Hits=replay.h100;osu.ui.interface.scorescreen.t100kHits=replay.hKatus;osu.ui.interface.scorescreen.t50Hits=replay.h50;osu.ui.interface.scorescreen.tMissHits=replay.hMisses;osu.ui.interface.scorescreen.maxCombo=replay.tCombo;osu.ui.interface.scorescreen.grade=replay.grade;osu.ui.interface.scorescreen.accuracy=replay.accuracy;setTimeout(function(){document.getElementById("render_zone").className="";osu.ui.interface.scorescreen.renderScoreScreen()},500)}var osu=osu||{};osu.ui=osu.ui||{};osu.ui.renderer={renderWidth:window.innerWidth,renderHeight:window.innerHeight,renderer:null,masterStage:new PIXI.Container,render_zone:document.getElementById("render_zone"),fixed_aspect:false,addChild:function addChild(child){this.masterStage.addChild(child)},removeChild:function removeChild(child){this.masterStage.removeChild(child)},clearStage:function clearStage(){this.masterStage.removeChildren()},animate:function animate(){event_handler.emit(event_handler.EVENTS.RENDER);this.renderer.render(this.masterStage);requestAnimationFrame(this.animate.bind(this))},resize:function resize(){var x=window.innerWidth;var y=window.innerHeight;if(this.fixed_aspect&&false){var fixed_ratio_y=3/4*x;var fixed_ratio_x=4/3*y;if(fixed_ratio_y>y){x=fixed_ratio_x}else{y=fixed_ratio_y}}this.renderWidth=x;this.renderHeight=y;if(this.renderer!=null){this.renderer.view.style.width=this.renderWidth+"px";this.renderer.view.style.height=this.renderHeight+"px"}},start:function start(){this.resize();if(this.renderer==null){this.renderer=PIXI.autoDetectRenderer(this.renderWidth,this.renderHeight);this.render_zone.appendChild(this.renderer.view);this.animate();window.onresize=this.resize.bind(this)}else{console.log("renderer already started resizing instead");this.renderer.width=this.renderWidth;this.renderer.height=this.renderHeight;this.renderer.view.width=this.renderWidth;this.renderer.view.height=this.renderHeight}},hide:function hide(){this.render_zone.innerHTML=""},show:function show(){this.render_zone.appendChild(this.renderer.view)}};var osu=osu||{};osu.ui=osu.ui||{};osu.ui.interface=osu.ui.interface||{};osu.ui.interface.replaycontroller={__$controlBar:$("#replay_control_zone"),__$togglePlayButton:$("#toggle_play_replay"),__$progressBar:$("#replay_progress"),__$volume:$("#replay_master_volume"),__$configButton:$("#open_config_button"),__$replayCurTime:$("#replay_current_time"),__$replayDuration:$("#replay_duration"),__eventsBound:false,__ignoreUpdates:false,_currentDuration:0,_currentPosition:0,showBar:function showBar(){this.__$controlBar.slideDown()},hideBar:function hideBar(){this.__$controlBar.slideUp()},convertMs:function convertMs(t){;var seconds=parseInt(t/1000%60);var minutes=parseInt(t/(1000*60)%60);var hours=parseInt(t/(1000*60*60)%24);hours=hours<10?"0"+hours:hours;minutes=minutes<10?"0"+minutes:minutes;seconds=seconds<10?"0"+seconds:seconds;return hours>0?hours+":"+minutes+":"+seconds:minutes+":"+seconds},set_duration:function set_duration(t){this.__$replayDuration.text(this.convertMs(t));this.__$progressBar.prop({max:t})},set_position:function set_position(t){if(!this.__ignoreUpdates){this.__$progressBar.val(t)}this.__$replayCurTime.text(this.convertMs(t))},__setVolume:function __setVolume(){this.__$volume.val(osu.settings.SETTINGS.master_volume*100)},showPauseIcon:function showPauseIcon(){this.__$togglePlayButton.prop({src:"data/player-pause-icon.png"})},showPlayIcon:function showPlayIcon(){this.__$togglePlayButton.prop({src:"data/player-play-icon.png"})},disable_progressbar:function disable_progressbar(){this.__$progressBar.prop("disabled",true)},enable_progressbar:function enable_progressbar(){this.__$progressBar.prop("disabled",false)},bindEvents:function bindEvents(){if(!this.__eventsBound){var self=this;this.__setVolume();this.__$togglePlayButton.on("click",function(){if(osu.ui.interface.scorescreen.replayStarted){osu.ui.interface.osugame.toggle_pause()}else{osu.ui.interface.scorescreen.start_replay()}});event_handler.on(event_handler.EVENTS.SETTINGS_CHANGED,this.__setVolume.bind(this));this.__$volume.on("input",function(){osu.settings.SETTINGS.master_volume=self.__$volume.val()/100});this.__$progressBar.on("input",function(){osu.ui.interface.osugame.go_to(self.__$progressBar.val())});this.__$configButton.on("click",function(){osu.ui.interface.osugame.toggle_settings()});this.__eventsBound=true}}};var event_handler={EVENTS:Object.freeze({BEATMAP_LOADING:1,BEATMAP_LOADED:2,BEATMAP_LOADING_FAILED:3,REPLAY_LOADING:4,REPLAY_LOADED:5,REPLAY_LOAD_FAILED:6,BEATMAP_NOTFOUND:7,DB_ERROR:8,ASSET_NOT_FOUND:9,RENDER:10,UNKNOWN_FILE_ERROR:11,INVALID_FILE:12,BEATMAP_SELECTED:13,STOP_REPLAY:14,SETTINGS_CHANGED:15,SKIN_LOADING:16,SKIN_LOADED:17,SKIN_LOADING_FAILED:18,RESOURCES_LOADING:19,RESOURCES_LOADED:20}),__events:{},on:function on(eventName,fn,alias,parent_object){this.__events[eventName]=this.__events[eventName]||[];this.__events[eventName].push({fn:fn,alias:alias,parent:parent_object})},off:function off(eventName,alias,fn){if(this.__events[eventName]){for(var i=0;i<this.__events[eventName].length;i++){if(this.__events[eventName][i].fn===fn){this.__events[eventName].splice(i,1);break}if(this.__events[eventName][i].alias==alias){this.__events[eventName].splice(i,1);break}}}},emit:function emit(eventName,data){if(DEBUG&&eventName!=event_handler.EVENTS.RENDER){console.log("EVENT: "+eventName);console.log(data)}if(this.__events[eventName]){this.__events[eventName].forEach(function(obj){if(obj.parent){obj.parent[obj.fn](data)}else{obj.fn(data)}})}}};event_handler.on(event_handler.EVENTS.SKIN_LOADING,function(data){var loading=new PNotify({title:"Loading skin",text:"Loading \n"+data,type:"info",hide:"false"});var alias=Date.now().toString();event_handler.on(event_handler.EVENTS.SKIN_LOADED,function(data_loaded){var options={type:"success",title:"Skin Loaded",text:data_loaded.name+"\n has been successfully processed",hide:"true"};loading.update(options);event_handler.off(event_handler.EVENTS.SKIN_LOADED,alias)},alias)});event_handler.on(event_handler.EVENTS.BEATMAP_LOADING,function(data){var loading=new PNotify({title:"Loading beatmap",text:"Loading \n"+data,type:"info",hide:"false"});var alias=Date.now().toString();event_handler.on(event_handler.EVENTS.BEATMAP_LOADED,function(data_loaded){var options={type:"success",title:"Beatmap Loaded",text:data_loaded.filename+"\n has been successfully processed",hide:"true"};loading.update(options);event_handler.off(event_handler.EVENTS.BEATMAP_LOADED,alias)},alias)});event_handler.on(event_handler.EVENTS.BEATMAP_LOADING_FAILED,function(data){PNotify.removeAll();new PNotify({title:"Beatmap Loading Failed",text:"Failed to load beatmap: "+data,type:"error"})});event_handler.on(event_handler.EVENTS.BEATMAP_LOADING_FAILED,function(data){new PNotify({title:"Beatmap Loading Failed",text:"Failed to load beatmap: "+data,type:"error"})});event_handler.on(event_handler.EVENTS.BEATMAP_NOTFOUND,function(data){new PNotify({title:"Beatmap not found",text:"Beatmap not found for replay, \n beatmap md5sum:\n"+data,type:"error"})});var parse_osu_map_data=function parse_osu_map_data(data){var beatmap_config={version:"",name:"",general:{},metadata:{},difficulty:{},events:[],timing_points:[],colours:{},hit_objects:[],minBPM:-1,maxBPM:-1,circles:0,sliders:0,spinners:0,time_length:0};var lines=data.replace("\r","").split("\n");beatmap_config.version=lines[0];var current_setting=null;var parentBPMS=500;for(var i=0;i<lines.length;i++){var line=lines[i].trim();if(line===""){continue}if(line.indexOf("//")==0){continue}if(line.indexOf("[")==0){current_setting=line.toLowerCase();continue}switch(current_setting){case"[general]":var settings=line.split(":");if(settings.length==2){beatmap_config.general[settings[0]]=settings[1].trim()}break;case"[editor]":break;case"[metadata]":var settings=line.split(":");if(settings.length>1){beatmap_config.metadata[settings[0]]=settings.splice(1).join(":").trim()}break;case"[difficulty]":var settings=line.split(":");if(settings.length==2){beatmap_config.difficulty[settings[0]]=parseFloat(settings[1])}break;case"[events]":beatmap_config.events.push(line.split(","));break;case"[timingpoints]":var parts=line.split(",");var timingPoint={offset:+parts[0],millisecondsPerBeat:+parts[1],meter:+parts[2],sampleType:+parts[3],sampleSet:+parts[4],volume:+parts[5],inherited:+parts[6],kaiMode:+parts[7]};if(timingPoint.inherited==1){parentBPMS=timingPoint.millisecondsPerBeat;if(parentBPMS<beatmap_config.minBPM||beatmap_config.minBPM===-1){if(beatmap_config.minBPM>beatmap_config.maxBPM){beatmap_config.maxBPM=beatmap_config.minBPM}beatmap_config.minBPM=parentBPMS}}else{if(timingPoint.millisecondsPerBeat>=0){timingPoint.millisecondsPerBeat=parentBPMS}else{var multiplier=Math.abs(100/timingPoint.millisecondsPerBeat);timingPoint.millisecondsPerBeat=parentBPMS/multiplier}}beatmap_config.minBPM=Math.round(60000/beatmap_config.minBPM);if(beatmap_config.maxBPM!=-1)beatmap_config.maxBPM=Math.round(60000/beatmap_config.maxBPM);beatmap_config.timing_points.push(timingPoint);break;case"[colours]":var settings=line.split(":");if(settings.length==2){beatmap_config.colours[settings[0]]=settings[1].split(",")}break;case"[hitobjects]":var hit_object=osu.objects.HitObjectParser.parse_line(line,beatmap_config.timing_points,beatmap_config.difficulty.SliderMultiplier||1);switch(hit_object.type){case osu.objects.HitObjectParser.TYPES.CIRCLE:beatmap_config.circles++;break;case osu.objects.HitObjectParser.TYPES.SLIDER:beatmap_config.sliders++;break;case osu.objects.HitObjectParser.TYPES.SPINNER:beatmap_config.spinners++;}beatmap_config.hit_objects.push(hit_object);break;}}var lastHitObject=beatmap_config.hit_objects[beatmap_config.hit_objects.length-1];beatmap_config.time_length=lastHitObject.endTime||lastHitObject.startTime;return beatmap_config};var BeatmapReader=function BeatmapReader(beatmap_zip_file,callback){var beatMap={maps:[],assets:[]};var md5sums=[];event_handler.emit(event_handler.EVENTS.BEATMAP_LOADING,beatmap_zip_file.name);var zip_length=0;var extracted=0;var beatmaps=0;var beatmaps_loaded=0;var beatmap_loaded=function beatmap_loaded(){if(beatmaps_loaded==beatmaps){event_handler.emit(event_handler.EVENTS.BEATMAP_LOADED,{md5sums:md5sums,filename:beatmap_zip_file.name});callback(beatMap)}};var create_thumbnail=function create_thumbnail(img_data){var MAX_WIDTH=232;var MAX_HEIGHT=130;var canvas=document.createElement("canvas");var img=document.createElement("img");img.src=img_data;var width=img.width;var height=img.height;if(width>height){if(width>MAX_WIDTH){height*=MAX_WIDTH/width;width=MAX_WIDTH}}else{if(height>MAX_HEIGHT){width*=MAX_HEIGHT/height;height=MAX_HEIGHT}}canvas.width=width;canvas.height=height;var ctx=canvas.getContext("2d");ctx.drawImage(img,0,0,width,height);return canvas.toDataURL("image/jpeg")};var processing_complete=function processing_complete(){if(extracted==zip_length){beatmaps=beatMap.maps.length;for(var i=0;i<beatMap.maps.length;i++){var beatmap=beatMap.maps[i];beatmap.parsed=parse_osu_map_data(beatmap.data);for(var k in beatmap.parsed.metadata){beatmap[k.toLocaleLowerCase()]=beatmap.parsed.metadata[k]}beatmap.files=[];var background_file_name=beatmap.parsed.events[0][2].replace(/"/g,"");var thumbnail="";for(var x=0;x<beatMap.assets.length;x++){beatmap.files.push({md5sum:beatMap.assets[x].md5sum,filename:beatMap.assets[x].filename});if(beatMap.assets[x].filename==background_file_name){beatmap.background=beatMap.assets[x].md5sum;thumbnail=create_thumbnail(beatMap.assets[x].data)}if(beatMap.assets[x].filename==beatmap.parsed.general.AudioFilename){beatmap.song=beatMap.assets[x].md5sum}}var thumbnail_md5sum=md5(thumbnail);beatmap.thumbnail=thumbnail_md5sum;var difficultyCalc=new osu.beatmaps.DifficultyCalculator(beatmap.parsed);beatmap.stars=difficultyCalc.calculate();md5sums.push(beatmap.md5sum);database.insert_data(database.TABLES.ASSETS,thumbnail_md5sum,thumbnail,function(){},function(){});osu.webapi.beatmaps.uploadBeatMap(beatmap);database.insert_data(database.TABLES.BEATMAPS,beatmap.md5sum,beatmap,function(){beatmaps_loaded++;beatmap_loaded()},function(){beatmaps_loaded++;beatmap_loaded()})}}};zip.createReader(new zip.BlobReader(beatmap_zip_file),function(reader){reader.getEntries(function(entries){if(entries.length){zip_length=entries.length;for(var i=0;i<entries.length;i++){if(entries[i].filename.split(".").pop()=="osu"){var extract_data=function extract_data(i){entries[i].getData(new zip.TextWriter,function(text){var filename=entries[i].filename;extracted++;var md5sum=md5(text);beatMap.maps.push({filename:filename,data:text,md5sum:md5sum});processing_complete()},function(current,total){})};extract_data(i)}else if(entries[i].filename.split(".").pop()=="png"){var extract_data=function extract_data(i){entries[i].getData(new zip.Data64URIWriter("image/png"),function(data){var filename=entries[i].filename;extracted++;var md5sum=md5(data);beatMap.assets.push({filename:filename,data:data,md5sum:md5sum});database.insert_data(database.TABLES.ASSETS,md5sum,data,processing_complete,processing_complete)},function(current,total){})};extract_data(i)}else if(entries[i].filename.split(".").pop()=="wav"){var extract_data=function extract_data(i){entries[i].getData(new zip.Data64URIWriter("audio/wav"),function(data){var filename=entries[i].filename;extracted++;var md5sum=md5(data);beatMap.assets.push({filename:filename,data:data,md5sum:md5sum});database.insert_data(database.TABLES.ASSETS,md5sum,data,processing_complete,processing_complete)},function(current,total){})};extract_data(i)}else if(entries[i].filename.split(".").pop()=="jpg"||entries[i].filename.split(".").pop()=="jpeg"){var extract_data=function extract_data(i){entries[i].getData(new zip.Data64URIWriter("image/jpeg"),function(data){var filename=entries[i].filename;extracted++;var md5sum=md5(data);beatMap.assets.push({filename:filename,data:data,md5sum:md5sum});database.insert_data(database.TABLES.ASSETS,md5sum,data,processing_complete,processing_complete)},function(current,total){})};extract_data(i)}else if(entries[i].filename.split(".").pop()=="mp3"){var extract_data=function extract_data(i){entries[i].getData(new zip.Data64URIWriter("audio/mpeg"),function(data){var filename=entries[i].filename;extracted++;var md5sum=md5(data);beatMap.assets.push({filename:filename,data:data,md5sum:md5sum});database.insert_data(database.TABLES.ASSETS,md5sum,data,processing_complete,processing_complete)},function(current,total){})};extract_data(i)}else{extracted++;processing_complete()}}}})},function(error){console.log(error)})};if(typeof window.FileReader==="undefined"){dragDropLabel.innerHTML="Shit won't work on this browser :("}else{document.body.ondragover=function(){return false};document.body.ondragend=function(){return false};document.body.ondrop=function(e){e.preventDefault();var file=e.dataTransfer.files[0];var reader=new FileReader;reader.onloadend=function(event){console.log(event);if(event.target.readyState===2){if(event.target.result.constructor.name=="ArrayBuffer"){var replay_data=new Uint8Array(event.target.result);var b64encoded=btoa(Uint8ToString(replay_data));osu.webapi.replays.uploadReplay(file,md5(b64encoded));ReplayParser(replay_data,function(replay_data){replay=replay_data;loadBeatMap()})}else{event.target.result=event.target.result.replace("audio/mp3","audio/mpeg");var md5sum=md5(event.target.result);database.insert_data(database.TABLES.ASSETS,md5sum,event.target.result,function(){},function(){})}}else{event_handler.emit(event_handler.EVENTS.UNKNOWN_FILE_ERROR)}};if(file.name.split(".").pop()=="osr"){reader.readAsArrayBuffer(file)}else if(file.name.split(".").pop()=="osz"){if(beatmap&&beatmap.locked){event_handler.emit(event_handler.EVENTS.BEATMAP_LOADING_FAILED,"beatmap is locked")}else{BeatmapReader(file,function(bm){beatmap=bm})}}else if(file.name.split(".").pop()=="osk"){SkinReader(file,function(skin){event_handler.emit(event_handler.EVENTS.SKIN_LOADED,skin)})}else{reader.readAsDataURL(file)}return false}}window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction;window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;var database={__db:null,__started:false,indexeddb_available:false,TABLES:Object.freeze({BEATMAPS:"beatmaps",REPLAYS:"replays",SKINS:"skins",ASSETS:"assets",OPTIONS:"options"}),INDEXES:Object.freeze({REPLAYS:{BEATMAP_ID:"beatmap_id",PLAYER:"player"}}),init:function init(onsucess){var self=this;var createDatabase=indexedDB.open("osu",1);createDatabase.onupgradeneeded=function(e){var thisDB=e.target.result;for(var k in database.TABLES){if(!thisDB.objectStoreNames.contains(database.TABLES[k])){var table=thisDB.createObjectStore(database.TABLES[k]);if(database.TABLES[k]==database.TABLES.BEATMAPS){table.createIndex("beatmapsetid","beatmapsetid",{unique:false});table.createIndex("title","title",{unique:false});table.createIndex("titleunicode","titleunicode",{unique:false});table.createIndex("artist","artist",{unique:false});table.createIndex("artistunicode","artistunicode",{unique:false});table.createIndex("creator","creator",{unique:false});table.createIndex("tags","tags",{unique:false})}if(database.TABLES[k]==database.TABLES.REPLAYS){table.createIndex("beatmap_id","bmMd5Hash",{unique:false});table.createIndex("player","playerName",{unique:false})}}}};createDatabase.onsuccess=function(e){self.__db=e.target.result;self.__started=true;this.indexeddb_available=true;onsucess()};createDatabase.onerror=function(e){console.log(e)}},insert_data:function insert_data(table,md5sum,data,onsuccess,onerror){if(this.__started){var transaction=this.__db.transaction([table],"readwrite").objectStore(table).add(data,md5sum);transaction.onsuccess=onsuccess;transaction.onerror=function(e){console.log(e.target.error);onerror(e)}}else{onerror("db not started")}},get_data:function get_data(table,md5sum,onsuccess,onerror){if(this.__started){var query=this.__db.transaction([table],"readonly").objectStore(table).get(md5sum);query.onsuccess=function(e){onsuccess({md5sum:md5sum,data:e.target.result})};query.onerror=onerror}else{onerror("db not started")}},get_count:function get_count(table,onsuccess){var countReq=this.__db.transaction([table],"readonly").objectStore(table).count();countReq.onsuccess=function(){onsuccess(countReq.result)}},delete_data:function delete_data(table,key,onsuccess){var request=this.__db.transaction([table],"readwrite").objectStore(table).delete(key);request.onsuccess=onsuccess},get_all_keys:function get_all_keys(table,callback){var request=this.__db.transaction([table],"readonly").objectStore(table);var result=[];request.openCursor().onsuccess=function(event){var cursor=event.target.result;if(cursor){result.push(cursor.key);cursor.continue()}else{callback(result)}}},get_data_from_index:function get_data_from_index(table,index,param,onsuccess,onerror){var result=[];var key=IDBKeyRange.only(param);var query=this.__db.transaction([table],"readonly").objectStore(table).index(index).openCursor(key).onsuccess=function(e){var cursor=e.target.result;if(cursor){result.push(cursor.value);cursor.continue()}else{onsuccess(result)}};query.onsuccess=function(e){onsuccess(e.target.result)}},getAll:function getAll(table,callback){var request=this.__db.transaction([table],"readonly").objectStore(table);var result=[];request.openCursor().onsuccess=function(event){var cursor=event.target.result;if(cursor){result.push(cursor.value);cursor.continue()}else{callback(result)}}},update_data:function update_data(table,key,data,onsuccess,onerror){onsuccess=onsuccess||function(){};onerror=onerror||function(){};if(this.__started){var transaction=this.__db.transaction([table],"readwrite").objectStore(table).put(data,key);transaction.onsuccess=onsuccess;transaction.onerror=function(e){console.log(e.target.error);onerror(e)}}else{onerror("db not started")}},delete_database:function delete_database(){if(DEBUG){indexedDB.deleteDatabase("osu")}else{console.log("no")}},clear_table:function clear_table(table_name){if(DEBUG){var transaction=this.__db.transaction([table_name],"readwrite");var objectStore=transaction.objectStore(table_name);var objectStoreRequest=objectStore.clear();objectStoreRequest.onsuccess=function(event){console.log(table_name+" cleared!")}}else{console.log("no")}}};var ReplayParser=function ReplayParser(replay_data,callback){event_handler.emit(event_handler.EVENTS.REPLAY_LOADING);var b64EncodedMd5=md5(btoa(Uint8ToString(replay_data)));var RP={replay_bytes:replay_data,byte_index:0,getByte:function getByte(){return this.replay_bytes[this.byte_index++]},getShort:function getShort(){return this.replay_bytes[this.byte_index++]|this.replay_bytes[this.byte_index++]<<8},getInteger:function getInteger(){return this.replay_bytes[this.byte_index++]|this.replay_bytes[this.byte_index++]<<8|this.replay_bytes[this.byte_index++]<<16|this.replay_bytes[this.byte_index++]<<24},getLong:function getLong(){return this.getInteger()+this.getInteger()*4294967296},getULEB128:function getULEB128(){var t=0;var s=0;while(true){var byte=this.getByte();t|=(byte&127)<<s;if((byte&128)===0)break;s+=7}return t},getString:function getString(){var startByte=this.getByte();if(startByte==11){var len=this.getULEB128();var s="";for(var i=0;i<len;i++){s+=String.fromCharCode(this.getByte())}return s}return""}};var replay={type:RP.getByte(),version:RP.getInteger(),bmMd5Hash:RP.getString(),playerName:RP.getString(),rMd5Hash:RP.getString(),h300:RP.getShort(),h100:RP.getShort(),h50:RP.getShort(),hGekis:RP.getShort(),hKatus:RP.getShort(),hMisses:RP.getShort(),tScore:RP.getInteger(),tCombo:RP.getShort(),fullClear:RP.getByte(),mods:osu.mods.getMods(RP.getInteger()),lifeBar:RP.getString(),time_played:RP.getLong(),replayByteLength:RP.getInteger(),b64md5sum:b64EncodedMd5};var epoch=(replay.time_played-621355968000000000)/10000;var date_time=new Date(epoch);replay.time_played=date_time.toLocaleString();replay.grade=osu.score.getGrade(replay.h300,replay.h100,replay.h50,replay.hMisses,replay.mods).name;replay.accuracy=osu.score.getAccuracy(replay.h300,replay.h100,replay.h50,replay.hMisses);replay.been_rendered=false;LZMA.decompress(RP.replay_bytes.slice(RP.byte_index),function(data){var replayData=data.split(",");var lastTimeFrame=0;for(var i=0;i<replayData.length;i++){var splitData=replayData[i].split("|");for(var x=0;x<splitData.length;x++){splitData[x]=parseFloat(splitData[x])}if(splitData.length!=4)continue;var time=+splitData[0];if(time>=0){time+=lastTimeFrame;lastTimeFrame=time}var replayFrame={t:time,x:splitData[1],y:splitData[2],keys:osu.keypress.get_keys(splitData[3])};replayData[i]=replayFrame}replay.replayData=replayData;database.insert_data(database.TABLES.REPLAYS,replay.rMd5Hash,replay,function(){event_handler.emit(event_handler.EVENTS.REPLAY_LOADED);callback(replay)},function(){event_handler.emit(event_handler.EVENTS.REPLAY_LOADED);callback(replay)})},function(){})};var SkinReader=function SkinReader(skin_zip,callback){event_handler.emit(event_handler.EVENTS.SKIN_LOADING,skin_zip.name);var skins={name:"",author:"",version:"",colours:[],assets:[],md5sum:""};zip.createReader(new zip.BlobReader(skin_zip),function(reader){var zip_length=0;var process_count=0;var processing_complete=function processing_complete(){process_count++;if(process_count>=zip_length){database.insert_data(database.TABLES.SKINS,skins.md5sum,skins,callback,callback)}};var RGBToHex=function RGBToHex(r,g,b){var bin=r<<16|g<<8|b;return function(h){return new Array(7-h.length).join("0")+h}(bin.toString(16).toUpperCase())};reader.getEntries(function(entries){if(entries.length){zip_length=entries.length;for(var i=0;i<entries.length;i++){var extension=entries[i].filename.split(".").pop();if(extension=="ini"){entries[i].getData(new zip.TextWriter,function(text){skins.md5sum=md5(text);var lines=text.replace("\r","").split("\n");for(var j=0;j<lines.length;j++){var line=lines[j];if(line===""){continue}if(line.indexOf("Name:")==0){var setting=line.split(":");if(setting.length>1)skins.name=setting[1].trim()}if(line.indexOf("Author:")==0){var setting=line.split(":");if(setting.length>1)skins.author=setting[1].trim()}if(line.indexOf("Version:")==0){var setting=line.split(":");if(setting.length>1)skins.version=setting[1].trim()}if(line.indexOf("Combo")==0){var setting=line.split(":");if(setting.length>1){var rgb=setting[1].trim().split(",");if(rgb.length===3){skins.colours.push(parseInt("0x"+RGBToHex(rgb[0],rgb[1],rgb[2])))}}}}processing_complete()})}else if(extension=="png"||extension=="wav"||extension=="mp3"){var filename=entries[i].filename.split("/");if(filename.length>1)filename=filename[1];else filename=filename[0];if(extension=="png"){(function(filename){if(DEBUG)console.log(filename);entries[i].getData(new zip.Data64URIWriter("image/png"),function(data){var md5sum=md5(data);skins.assets.push({filename:filename,md5sum:md5sum});database.insert_data(database.TABLES.ASSETS,md5sum,data,processing_complete,processing_complete)})})(filename)}else if(extension=="wav"){(function(filename){if(DEBUG)console.log(filename);entries[i].getData(new zip.Data64URIWriter("audio/wav"),function(data){var md5sum=md5(data);skins.assets.push({filename:filename,md5sum:md5sum});database.insert_data(database.TABLES.ASSETS,md5sum,data,processing_complete,processing_complete)})})(filename)}else{(function(filename){if(DEBUG)console.log(filename);entries[i].getData(new zip.Data64URIWriter("audio/mpeg"),function(data){var md5sum=md5(data);skins.assets.push({filename:filename,md5sum:md5sum});database.insert_data(database.TABLES.ASSETS,md5sum,data,processing_complete,processing_complete)})})(filename)}}else{processing_complete()}}}})})};var osu=osu||{};osu.audio=osu.audio||{};osu.audio.HitSound={HIT_SOUNDS:{SOUND_NORMAL:"HITNORMAL",SOUND_WHISTLE:"HITWHISTLE",SOUND_FINISH:"HITFINISH",SOUND_CLAP:"HITCLAP"},HIT_ADDITIONS:{NORMAL:"NORMAL_",SOFT:"SOFT_",DRUM:"DRUM_"},getHitSounds:function getHitSounds(hitSoundArray,timing,noNormals){noNormals=noNormals||false;var soundArray=[];var hitAdditons=this.HIT_ADDITIONS.NORMAL;switch(timing.sampleType){case osu.objects.HitObjectParser.HIT_ADDITIONS.DRUM:hitAdditons=this.HIT_ADDITIONS.DRUM;break;case osu.objects.HitObjectParser.HIT_ADDITIONS.SOFT:hitAdditons=this.HIT_ADDITIONS.SOFT;}if(!noNormals){soundArray.push(osu.audio.sound[this.HIT_ADDITIONS.NORMAL+this.HIT_SOUNDS.SOUND_NORMAL])}for(var i=0;i<hitSoundArray.length;i++){switch(hitSoundArray[i]){case osu.objects.HitObjectParser.HIT_SOUNDS.SOUND_NORMAL:break;case osu.objects.HitObjectParser.HIT_SOUNDS.SOUND_WHISTLE:soundArray.push(osu.audio.sound[hitAdditons+this.HIT_SOUNDS.SOUND_WHISTLE]);break;case osu.objects.HitObjectParser.HIT_SOUNDS.SOUND_FINISH:soundArray.push(osu.audio.sound[hitAdditons+this.HIT_SOUNDS.SOUND_FINISH]);break;case osu.objects.HitObjectParser.HIT_SOUNDS.SOUND_CLAP:soundArray.push(osu.audio.sound[hitAdditons+this.HIT_SOUNDS.SOUND_CLAP]);break;}}return soundArray}};var osu=osu||{};osu.audio=osu.audio||{};osu.audio.music={preview_screen:false,preview_time:0,__audio:new Audio,md5sum:"",playing:false,events_bound:false,init:function init(src,md5sum){if(!this.events_bound){event_handler.on(event_handler.EVENTS.SETTINGS_CHANGED,this.set_volume.bind(this));this.events_bound=true}if(src&&md5sum!=this.md5sum){this.md5sum=md5sum;this.__audio.pause();this.__audio.src=src;this.set_volume();this.playing=false}this.set_playback_speed(1)},set_volume:function set_volume(){this.__audio.volume=osu.settings.SETTINGS.master_volume*osu.settings.SETTINGS.music_volume},stop:function stop(){this.__audio.pause();this.__audio.currentTime=0},start:function start(){if(this.preview_screen){if(!this.playing){this.__audio.currentTime=this.preview_time;this.__audio.play();this.playing=true}}else{this.__audio.currentTime=0;this.__audio.play()}},set_position:function set_position(t){this.__audio.currentTime=t},play:function play(){this.__audio.play()},pause:function pause(){this.__audio.pause()},set_playback_speed:function set_playback_speed(rate){this.__audio.playbackRate=rate},repeat:function repeat(){if(this.preview_screen){this.playing=false;this.start()}}};var osu=osu||{};osu.audio=osu.audio||{};osu.audio.sound={APPLAUSE:"",COMBOBREAK:"",COUNT1S:"",COUNT2S:"",COUNT3S:"",DRUM_HITCLAP:"",DRUM_HITFINISH:"",DRUM_HITNORMAL:"",DRUM_HITWHISTLE:"",DRUM_SLIDERSLIDE:"",DRUM_SLIDERTICK:"",DRUM_SLIDERWHISTLE:"",FAILSOUND:"",GOS:"",MENUBACK:"",MENUCLICK:"",MENUHIT:"",NORMAL_HITCLAP:"",NORMAL_HITFINISH:"",NORMAL_HITNORMAL:"",NORMAL_HITWHISTLE:"",NORMAL_SLIDERSLIDE:"",NORMAL_SLIDERTICK:"",NORMAL_SLIDERWHISTLE:"",READYS:"",SECTIONFAIL:"",SECTIONPASS:"",SHUTTER:"",SOFT_HITCLAP:"",SOFT_HITFINISH:"",SOFT_HITNORMAL:"",SOFT_HITWHISTLE:"",SOFT_SLIDERSLIDE:"",SOFT_SLIDERTICK:"",SOFT_SLIDERWHISTLE:"",SPINNERBONUS:"",SPINNER_OSU:"",SPINNERSPIN:"",initialised:false,play_sound:function play_sound(effect,volume){if(!this.initialised||effect=="")return;volume=volume||1;effect.volume=osu.settings.SETTINGS.master_volume*osu.settings.SETTINGS.sound_effects_volume*volume;effect.currentTime=0;effect.play()},init:function init(){this.APPLAUSE=new Audio(src=osu.skins.audio.applause);this.COMBOBREAK=new Audio(src=osu.skins.audio.combobreak);this.COUNT1S=new Audio(src=osu.skins.audio.count1s);this.COUNT2S=new Audio(src=osu.skins.audio.count2s);this.COUNT3S=new Audio(src=osu.skins.audio.count3s);this.DRUM_HITCLAP=new Audio(src=osu.skins.audio.drum_hitclap);this.DRUM_HITFINISH=new Audio(src=osu.skins.audio.drum_hitfinish);this.DRUM_HITNORMAL=new Audio(src=osu.skins.audio.drum_hitnormal);this.DRUM_HITWHISTLE=new Audio(src=osu.skins.audio.drum_hitwhistle);this.DRUM_SLIDERSLIDE=new Audio(src=osu.skins.audio.drum_sliderslide);this.DRUM_SLIDERTICK=new Audio(src=osu.skins.audio.drum_slidertick);this.DRUM_SLIDERWHISTLE=new Audio(src=osu.skins.audio.drum_sliderwhistle);this.FAILSOUND=new Audio(src=osu.skins.audio.failsound);this.GOS=new Audio(src=osu.skins.audio.gos);this.MENUBACK=new Audio(src=osu.skins.audio.menuback);this.MENUCLICK=new Audio(src=osu.skins.audio.menuclick);this.MENUHIT=new Audio(src=osu.skins.audio.menuhit);this.NORMAL_HITCLAP=new Audio(src=osu.skins.audio.normal_hitclap);this.NORMAL_HITFINISH=new Audio(src=osu.skins.audio.normal_hitfinish);this.NORMAL_HITNORMAL=new Audio(src=osu.skins.audio.normal_hitnormal);this.NORMAL_HITWHISTLE=new Audio(src=osu.skins.audio.normal_hitwhistle);this.NORMAL_SLIDERSLIDE=new Audio(src=osu.skins.audio.normal_sliderslide);this.NORMAL_SLIDERTICK=new Audio(src=osu.skins.audio.normal_slidertick);this.NORMAL_SLIDERWHISTLE=new Audio(src=osu.skins.audio.normal_sliderwhistle);this.READYS=new Audio(src=osu.skins.audio.readys);this.SECTIONFAIL=new Audio(src=osu.skins.audio.sectionfail);this.SECTIONPASS=new Audio(src=osu.skins.audio.sectionpass);this.SHUTTER=new Audio(src=osu.skins.audio.shutter);this.SOFT_HITCLAP=new Audio(src=osu.skins.audio.soft_hitclap);this.SOFT_HITFINISH=new Audio(src=osu.skins.audio.soft_hitfinish);this.SOFT_HITNORMAL=new Audio(src=osu.skins.audio.soft_hitnormal);this.SOFT_HITWHISTLE=new Audio(src=osu.skins.audio.soft_hitwhistle);this.SOFT_SLIDERSLIDE=new Audio(src=osu.skins.audio.soft_sliderslide);this.SOFT_SLIDERTICK=new Audio(src=osu.skins.audio.soft_slidertick);this.SOFT_SLIDERWHISTLE=new Audio(src=osu.skins.audio.soft_sliderwhistle);this.SPINNERBONUS=new Audio(src=osu.skins.audio.spinnerbonus);this.SPINNER_OSU=new Audio(src=osu.skins.audio.spinner_osu);this.SPINNERSPIN=new Audio(src=osu.skins.audio.spinnerspin);this.initialised=true}};var osu=osu||{};osu.beatmaps=osu.beatmaps||{};osu.beatmaps.BeatmapPreview=function(){function BeatmapPreview(md5sum,callback){_classCallCheck(this,BeatmapPreview);callback=callback||function(){};this.loaded=false;this.artist="";this.artistunicode="";this.beatmapid="";this.beatmapsetid="";this.creator="";this.md5sum=md5sum;this.source="";this.tags="";this.thumbnail_data="";this.title="";this.titleunicode="";this.version="";this.song="";this.preview_song_time=0;this.background="";this.approachRate="";this.circleSize="";this.overallDifficulty="";this.HPDrain="";this.stars="";this.bpm=0;this.objects=0;this.circles=0;this.sliders=0;this.spinners=0;this.song_length="";var self=this;database.get_data(database.TABLES.BEATMAPS,md5sum,function(r){var beatmap=r.data;self.artist=beatmap.artist||"";self.artistunicode=beatmap.artistunicode==beatmap.artist?false:beatmap.artistunicode;self.artistunicode=beatmap.artistunicode||null;self.beatmapid=beatmap.beatmapid||"";self.beatmapsetid=beatmap.beatmapsetid||"";self.creator=beatmap.creator||"";self.source=beatmap.source||"";self.tags=beatmap.tags||"";self.title=beatmap.title||"";self.titleunicode=beatmap.titleunicode==beatmap.title?false:beatmap.titleunicode;self.version=beatmap.version||"";self.song=beatmap.song||"";self.preview_song_time=parseInt(beatmap.parsed.general.PreviewTime)||0;self.background=beatmap.background||"";self.approachRate=beatmap.parsed.difficulty.ApproachRate||0;self.circleSize=beatmap.parsed.difficulty.CircleSize||0;self.overallDifficulty=beatmap.parsed.difficulty.OverallDifficulty||0;self.HPDrain=beatmap.parsed.difficulty.HPDrainRate||0;self.minBPM=beatmap.parsed.minBPM;self.maxBPM=beatmap.parsed.maxBPM==-1?false:beatmap.parsed.maxBPM;self.circles=beatmap.parsed.circles||0;self.sliders=beatmap.parsed.sliders||0;self.spinners=beatmap.parsed.spinners||0;self.objects=self.circles+self.sliders+self.spinners;self.stars=parseFloat(beatmap.stars);self.display_stars=[];var stars=self.stars;for(var i=0;i<=Math.ceil(self.stars);i++){if(i>9)break;if(stars>1){self.display_stars.push({h:52,w:50,star_img:osu.skins.resources.star.url})}else{if(stars>=0){self.display_stars.push({h:52*stars,w:50*stars,star_img:osu.skins.resources.star.url})}}stars-=1}var milliseconds=beatmap.parsed.time_length;var seconds=parseInt(milliseconds/1000%60);var minutes=parseInt(milliseconds/(1000*60)%60);var hours=parseInt(milliseconds/(1000*60*60)%24);var pad=function pad(s){return("00"+s).substring(s.length)};self.song_length=(hours>0?hours.toString()+":":"")+pad(minutes.toString())+":"+pad(seconds.toString());database.get_data(database.TABLES.ASSETS,beatmap.thumbnail,function(result){self.thumbnail_data=result.data;self.loaded=true;callback(this)})})}_createClass(BeatmapPreview,[{key:"play_song",value:function play_song(){var preview_time=this.preview_song_time;database.get_data(database.TABLES.ASSETS,this.song,function(r){osu.audio.music.preview_time=preview_time/1000;osu.audio.music.preview_screen=true;osu.audio.music.init(r.data,r.md5sum);osu.audio.music.start()})}},{key:"load_background",value:function load_background(){database.get_data(database.TABLES.ASSETS,this.background,function(r){osu.ui.interface.mainscreen.set_background(r.data)})}}]);return BeatmapPreview}();osu.beatmaps.BeatmapLoader={beatmap_found:false,map_name:"",required_files:[],background:"",map_data:"",assets:[],song:"",__beatmap:"",__files_needed:[],md5sum:"",load:function load(md5sum,onsuccess,onerror){this.beatmap_found=false;this.map_name=false;this.required_files=[];this.assets=[];this.song="";this.song_md5sum="";this.__beatmap="";this.__files_needed=[];this.background="";this.md5sum=md5sum;this.onsuccess=onsuccess;this.onerror=onerror;if(beatmap){for(var i=0;i<beatmap.maps.length;i++){if(beatmap.maps[i].md5sum==md5sum){beatmap.locked=true;this.map_data=beatmap.maps[i].parsed;this.required_files=beatmap.maps[i].files;this.assets=beatmap.assets;this.beatmap_found=true;break}}if(this.beatmap_found){this.__beatmap_loaded()}else{this.__look_in_db()}}else{this.__look_in_db()}},__look_in_db:function __look_in_db(){database.get_data(database.TABLES.BEATMAPS,this.md5sum,this.__load_bm_from_db.bind(this),function(e){event_handler.emit(event_handler.EVENTS.DB_ERROR,e.event.error)})},__load_bm_from_db:function __load_bm_from_db(result){if(result&&result.data){this.__beatmap=result.data;this.map_data=this.__beatmap.parsed;this.required_files=this.__beatmap.files;this.__files_needed=this.__beatmap.files.slice(0);var file_to_get=this.__files_needed.pop().md5sum;database.get_data(database.TABLES.ASSETS,file_to_get,this.__load_assets_from_db.bind(this),function(e){event_handler.emit(event_handler.EVENTS.DB_ERROR,e.event.error)})}else{event_handler.emit(event_handler.EVENTS.BEATMAP_NOTFOUND,result.md5sum)}},__load_assets_from_db:function __load_assets_from_db(result){if(result&&result.data){this.assets.push(result)}else{event_handler.emit(event_handler.EVENTS.ASSET_NOT_FOUND,result.md5sum)}if(this.__files_needed.length){var file_to_get=this.__files_needed.pop().md5sum;database.get_data(database.TABLES.ASSETS,file_to_get,this.__load_assets_from_db.bind(this),function(e){event_handler.emit(event_handler.EVENTS.DB_ERROR,e.event.error)})}else{this.beatmap_found=true;this.__beatmap_loaded()}},__beatmap_loaded:function __beatmap_loaded(){if(this.beatmap_found){this.__process_beatmap();if(this.song){this.onsuccess(this)}}else{event_handler.emit(event_handler.EVENTS.BEATMAP_NOTFOUND,this.md5sum);this.onerror("beatmap not found: "+this.md5sum)}},__process_beatmap:function __process_beatmap(){this.song_md5sum=this.__lookup_file_md5(this.map_data.general.AudioFilename);this.song=this.__get_asset_from_md5(this.song_md5sum);this.background=this.__get_asset_from_md5(this.__lookup_file_md5(this.map_data.events[0][2].replace(/"/g,"")));this.map_name=this.map_data.metadata.Artist+" - "+this.map_data.metadata.Title+" ["+this.map_data.metadata.Version+"]";this.author=this.map_data.metadata.Creator;if(this.song_md5sum=="76e7fb7b5077cad2e8540f7dec55cfd1"&&!this.song){this.song="data/Rostik - Liquid (Paul Rosenthal Remix).mp3"}if(!this.song){osu.webapi.audio.findAudio(this,this.onsuccess)}},__lookup_file_md5:function __lookup_file_md5(filename){for(var i=0;i<this.required_files.length;i++){if(this.required_files[i].filename==filename){return this.required_files[i].md5sum}}},__get_asset_from_md5:function __get_asset_from_md5(md5){for(var i=0;i<this.assets.length;i++){if(this.assets[i].md5sum==md5){return this.assets[i].data}}}};var osu=osu||{};osu.beatmaps=osu.beatmaps||{};osu.beatmaps.DifficultyCalculator=function(){_createClass(DifficultyCalculator,null,[{key:"DifficultyType",get:function get(){return Object.freeze({SPEED:0,AIM:1})}}]);function DifficultyCalculator(parsedBeatmapData){_classCallCheck(this,DifficultyCalculator);this.TpHitObject=function(){function TpHitObject(hitObject){_classCallCheck(this,TpHitObject);this.TpSlider=function(){function TpSlider(hitObject){_classCallCheck(this,TpSlider);this.startTime=hitObject.startTime;this.sliderTime=(hitObject.endTime-this.startTime)/hitObject.repeatCount;this.curve=new osu.objects.Curve(hitObject)}_createClass(TpSlider,[{key:"getPosAtTime",value:function getPosAtTime(time){var t=(time-this.startTime)/this.sliderTime;var floor=Math.floor(t);t=floor%2==0?t-floor:floor+1-t;return this.curve.get_point(t)}}]);return TpSlider}();this.DECAY_BASE=[0.3,0.15];this.ALMOST_DIAMETER=90;this.STREAM_SPACING_TRESHOLD=110;this.SINGLE_SPACING_TRESHOLD=125;this.SPACING_WEIGHT_SCALING=[1400,26.25];this.LAZY_SLIDER_STEP_LENGTH=1;this.lazySliderLengthFirst=0;this.lazySliderLengthSubsequent=0;this.strains=[1,1];this.hitObject=hitObject;var scalingFactor=52/hitObject.size;this.normalizedStartPosition={x:hitObject.x*scalingFactor,y:hitObject.y*scalingFactor};if(hitObject.is_slider){var slider=new this.TpSlider(hitObject);var sliderFollowCircleRadius=hitObject.size*3;var segmentLength=slider.sliderTime;var segmentEndTime=segmentLength+hitObject.startTime;var cursorPos={x:hitObject.x,y:hitObject.y};for(var time=hitObject.startTime+this.LAZY_SLIDER_STEP_LENGTH;time<segmentEndTime;time+=this.LAZY_SLIDER_STEP_LENGTH){var sliderPos=slider.getPosAtTime(time);var difference={x:sliderPos.x,y:sliderPos.y};difference.x-=cursorPos.x;difference.y-=cursorPos.y;var distance=Math.sqrt(difference.x*difference.x+difference.y*difference.y);if(distance>sliderFollowCircleRadius){difference.x/=distance;difference.y/=distance;distance-=sliderFollowCircleRadius;cursorPos.x+=difference.x*distance;cursorPos.y+=difference.y*distance;this.lazySliderLengthFirst+=distance}}this.lazySliderLengthFirst*=scalingFactor;if(hitObject.repeatCount%2==1){this.normalizedEndPosition={x:cursorPos.x*scalingFactor,y:cursorPos.y*scalingFactor}}if(hitObject.repeatCount>1){segmentEndTime+=segmentLength;for(var time=segmentEndTime-segmentLength+this.LAZY_SLIDER_STEP_LENGTH;time<segmentEndTime;time+=this.LAZY_SLIDER_STEP_LENGTH){var sliderPos=slider.getPosAtTime(time);var difference={x:sliderPos.x,y:sliderPos.y};difference.x-=cursorPos.x;difference.y-=cursorPos.y;var distance=Math.sqrt(difference.x*difference.x+difference.y*difference.y);if(distance>sliderFollowCircleRadius){difference.x/=distance;difference.y/=distance;distance-=sliderFollowCircleRadius;cursorPos.x+=difference.x*distance;cursorPos.y+=difference.y*distance;this.lazySliderLengthFirst+=distance}}this.lazySliderLengthSubsequent*=scalingFactor;if(hitObject.repeatCount%2==0){this.normalizedEndPosition={x:cursorPos.x*scalingFactor,y:cursorPos.y*scalingFactor}}}}else{this.normalizedEndPosition={x:this.normalizedStartPosition.x,y:this.normalizedStartPosition.y}}}_createClass(TpHitObject,[{key:"getStrain",value:function getStrain(type){return this.strains[type]}},{key:"calculateStrains",value:function calculateStrains(previousHitObject){this.calculateSpecificStrain(previousHitObject,osu.beatmaps.DifficultyCalculator.DifficultyType.SPEED);this.calculateSpecificStrain(previousHitObject,osu.beatmaps.DifficultyCalculator.DifficultyType.AIM)}},{key:"spacingWeight",value:function spacingWeight(distance,type){switch(type){case osu.beatmaps.DifficultyCalculator.DifficultyType.SPEED:var weight;if(distance>this.SINGLE_SPACING_TRESHOLD)weight=2.5;else if(distance>this.STREAM_SPACING_TRESHOLD)weight=1.6+0.9*(distance-this.STREAM_SPACING_TRESHOLD)/(this.SINGLE_SPACING_TRESHOLD-this.STREAM_SPACING_TRESHOLD);else if(distance>this.ALMOST_DIAMETER)weight=1.2+0.4*(distance-this.ALMOST_DIAMETER)/(this.STREAM_SPACING_TRESHOLD-this.ALMOST_DIAMETER);else if(distance>this.ALMOST_DIAMETER/2)weight=0.95+0.25*(distance-this.ALMOST_DIAMETER/2)/(this.ALMOST_DIAMETER/2);else weight=0.95;return weight;case osu.beatmaps.DifficultyCalculator.DifficultyType.AIM:return Math.pow(distance,0.99);default:return 0;}}},{key:"calculateSpecificStrain",value:function calculateSpecificStrain(previousHitObject,type){var addition=0;var timeElapsed=this.hitObject.startTime-previousHitObject.hitObject.startTime;var decay=Math.pow(this.DECAY_BASE[type],timeElapsed/1000);if(this.hitObject.is_spinner){}else if(this.hitObject.is_slider){switch(type){case osu.beatmaps.DifficultyCalculator.DifficultyType.SPEED:addition=this.spacingWeight(previousHitObject.lazySliderLengthFirst+previousHitObject.lazySliderLengthSubsequent*(Math.max(previousHitObject.hitObject.repeatCount||0,1)-1)+this.distanceTo(previousHitObject),type)*this.SPACING_WEIGHT_SCALING[type];break;case osu.beatmaps.DifficultyCalculator.DifficultyType.AIM:var spaceWeight1=this.spacingWeight(previousHitObject.lazySliderLengthFirst,type);var spaceWeight2=this.spacingWeight(previousHitObject.lazySliderLengthSubsequent,type);addition=(spaceWeight1+spaceWeight2*(Math.max(previousHitObject.hitObject.repeatCount||0,1)-1)+this.spacingWeight(this.distanceTo(previousHitObject),type))*this.SPACING_WEIGHT_SCALING[type];break;}}else if(this.hitObject.is_circle){addition=this.spacingWeight(this.distanceTo(previousHitObject),type)*this.SPACING_WEIGHT_SCALING[type]}addition/=Math.max(timeElapsed,50);this.strains[type]=previousHitObject.strains[type]*decay+addition}},{key:"distanceTo",value:function distanceTo(prevHitObject){var x=this.normalizedStartPosition.x-prevHitObject.normalizedEndPosition.x;var y=this.normalizedStartPosition.y-prevHitObject.normalizedEndPosition.y;return Math.sqrt(x*x+y*y)}}]);return TpHitObject}();this.beatmap=parsedBeatmapData;this.STAR_SCALING_FACTOR=0.0675;this.EXTREME_SCALING_FACTOR=0.5;this.STRAIN_STEP=400;this.DECAY_WEIGHT=0.9;this.tpHitObjects=[];this.starRating=-1;this.difficulties=[-1,-1];this.stars=[-1,-1]}_createClass(DifficultyCalculator,[{key:"calculate",value:function calculate(){var circleSize=osu.helpers.constants.OSU_GAME_WIDTH/16*(1-0.7*(this.beatmap.difficulty.CircleSize-5)/5);for(var i=0;i<this.beatmap.hit_objects.length;i++){var hitObject=new osu.objects.HitObject(this.beatmap.hit_objects[i],circleSize,this.beatmap.difficulty.ApproachRate);this.tpHitObjects.push(new this.TpHitObject(hitObject))}if(!this.calculateStrainValues()){console.log("Could not compute strain values. Aborting difficulty calculation.");return 0}this.difficulties[osu.beatmaps.DifficultyCalculator.DifficultyType.SPEED]=this.calculateDifficulty(osu.beatmaps.DifficultyCalculator.DifficultyType.SPEED);this.difficulties[osu.beatmaps.DifficultyCalculator.DifficultyType.AIM]=this.calculateDifficulty(osu.beatmaps.DifficultyCalculator.DifficultyType.AIM);this.stars[osu.beatmaps.DifficultyCalculator.DifficultyType.SPEED]=Math.sqrt(this.difficulties[osu.beatmaps.DifficultyCalculator.DifficultyType.SPEED])*this.STAR_SCALING_FACTOR;this.stars[osu.beatmaps.DifficultyCalculator.DifficultyType.AIM]=Math.sqrt(this.difficulties[osu.beatmaps.DifficultyCalculator.DifficultyType.AIM])*this.STAR_SCALING_FACTOR;this.starRating=this.stars[osu.beatmaps.DifficultyCalculator.DifficultyType.SPEED]+this.stars[osu.beatmaps.DifficultyCalculator.DifficultyType.AIM]+Math.abs(this.stars[osu.beatmaps.DifficultyCalculator.DifficultyType.SPEED]-this.stars[osu.beatmaps.DifficultyCalculator.DifficultyType.AIM])*this.EXTREME_SCALING_FACTOR;return this.starRating.toFixed(2)}},{key:"calculateStrainValues",value:function calculateStrainValues(){if(this.tpHitObjects.length==0){console.log("Can not compute difficulty of empty beatmap.");return false}var currentHitObject=this.tpHitObjects[0];var nextHitObject;var index=0;while(++index<this.tpHitObjects.length){nextHitObject=this.tpHitObjects[index];nextHitObject.calculateStrains(currentHitObject);currentHitObject=nextHitObject}return true}},{key:"calculateDifficulty",value:function calculateDifficulty(type){var highestStrains=[];var intervalEndTime=this.STRAIN_STEP;var maximumStrain=0;var previousHitObject=null;for(var i=0;i<this.tpHitObjects.length;i++){var hitObject=this.tpHitObjects[i];while(hitObject.hitObject.startTime>intervalEndTime){highestStrains.push(maximumStrain);if(previousHitObject==null)maximumStrain=0;else{var decay=Math.pow(previousHitObject.DECAY_BASE[type],(intervalEndTime-previousHitObject.hitObject.startTime)/1000);maximumStrain=previousHitObject.getStrain(type)*decay}intervalEndTime+=this.STRAIN_STEP}if(hitObject.getStrain(type)>maximumStrain)maximumStrain=hitObject.getStrain(type);previousHitObject=hitObject}var difficulty=0;var weight=1;var sortNum=function sortNum(a,b){return b-a};highestStrains.sort(sortNum);for(var i=0;i<highestStrains.length;i++){var strain=highestStrains[i];difficulty+=weight*strain;weight*=this.DECAY_WEIGHT}return difficulty}}]);return DifficultyCalculator}();var osu=osu||{};osu.calculateReplay=function(hitobjects,replayframes,unscaledCircleSize){var isIn=function isIn(objectPos,curPos,radius){var distance=Math.hypot(objectPos.x-(curPos.orig_x||curPos.x),objectPos.y-(curPos.orig_y||curPos.y));var result=distance<=radius;return result};var replayOffset=(replayframes[2].orig_t||replayframes[2].t)*-1;if(replayOffset<0)replayOffset=1;var lastFrame=2;var keyPresses=[];var K1M1Down=false;var K2M2Down=false;var keyDown=false;var radius=unscaledCircleSize/2;var M1=false;var M2=false;var K1=false;var K2=false;var SMOKE=false;for(var i=0;i<hitobjects.length;i++){var hitObject=hitobjects[i];var hitTime=hitObject.startTime;var IS_HIT=false;var sliderPoints=hitObject.object.ticks||[];var repeatCount=hitObject.repeatCount||0;var currentRepeat=0;if(hitObject.is_slider){var startPoint={x:hitObject.x,y:hitObject.y,hitCount:1,timesHit:0};var endPoint=hitObject.object.curves.points[hitObject.object.curves.points.length-1];endPoint.hitCount=1;endPoint.timesHit=0;if(repeatCount===0){for(var z=0;z<sliderPoints.length;z++){sliderPoints[z].hitCount=1;sliderPoints[z].timesHit=0}sliderPoints.push(startPoint);sliderPoints.push(endPoint)}else{}}var REPLAYHIT=false;for(true;lastFrame<replayframes.length;lastFrame++){var replayFrame=replayframes[lastFrame];if((typeof replayFrame==="undefined"?"undefined":_typeof(replayFrame))!="object")break;var difference=hitTime-((replayFrame.orig_t||replayFrame.t)-replayOffset);if(hitObject.is_circle&&difference<hitObject.hitOffset.HIT_50*-1){break}else if(difference<(hitObject.endTime-hitObject.startTime)*-1){break}var isClick=false;M1=false;M2=false;K1=false;K2=false;SMOKE=false;for(var j=0;j<replayFrame.keys.length;j++){var key=replayFrame.keys[j];if(key==osu.keypress.KEYS.M1||key==osu.keypress.KEYS.K1){if(K1M1Down==false){isClick=true;K1M1Down=true;keyDown=true}M1=key==osu.keypress.KEYS.M1;K1=key==osu.keypress.KEYS.K1}if(key==osu.keypress.KEYS.M2||key==osu.keypress.KEYS.K2){if(K2M2Down==false){isClick=true;K2M2Down=true;keyDown=true}M2=key==osu.keypress.KEYS.M2;K2=key==osu.keypress.KEYS.K2}if(key==osu.keypress.KEYS.SMOKE){SMOKE=true}}if(!M1&&!K1){K1M1Down=false}if(!M2&&!K2){K2M2Down=false}if(!K1M1Down&&!K2M2Down){keyDown=false}difference=Math.abs(difference);var circleHit=false;if(!hitObject.is_spinner&&isClick&&!IS_HIT&&isIn(hitObject,replayFrame,radius)){if(difference<=hitObject.hitOffset.HIT_300){hitObject.hitType="HIT_300";hitObject.hitTime=(replayFrame.orig_t||replayFrame.t)-replayOffset;IS_HIT=true;REPLAYHIT=true;circleHit=true}else if(difference<=hitObject.hitOffset.HIT_100){hitObject.hitType="HIT_100";hitObject.hitTime=(replayFrame.orig_t||replayFrame.t)-replayOffset;IS_HIT=true;REPLAYHIT=true;circleHit=true}else if(difference<=hitObject.hitOffset.HIT_50){hitObject.hitType="HIT_50";hitObject.hitTime=(replayFrame.orig_t||replayFrame.t)-replayOffset;IS_HIT=true;REPLAYHIT=true;circleHit=true}else if(difference<=hitObject.hitOffset.HIT_MISS){hitObject.hitType="HIT_MISS";hitObject.hitTime=(replayFrame.orig_t||replayFrame.t)-replayOffset;IS_HIT=true;REPLAYHIT=true;circleHit=true}}keyPresses.push({M1:M1,M2:M2,K1:K1,K2:K2,SMOKE:SMOKE,REPLAYHIT:circleHit,ID:i,t:(replayFrame.orig_t||replayFrame.t)-replayOffset});if(REPLAYHIT&&hitObject.is_circle){replayFrame++;break}if(REPLAYHIT&&hitObject.is_slider){if(hitObject.object.scoreBreak){replayFrame++;break}var duration=hitObject.duration/hitObject.repeatCount+1;var t=difference-currentRepeat*duration;if(t<=duration){var sliderPos;if(currentRepeat==0||currentRepeat%2==0){sliderPos=hitObject.object.curves.get_point(t/duration)}else{sliderPos=hitObject.object.curves.get_point(1-t/duration)}for(var z=0;z<sliderPoints.length;z++){if(isIn(sliderPos,sliderPoints[z],radius*3)){sliderPoints[z].timesHit++}}if(isIn(sliderPos,replayFrame,radius*3)){hitObject.object.scoreBreak=false}else{var sliderBreak=false;for(z=0;z<sliderPoints.length;z++){if(sliderPoints[z].timesHit<sliderPoints[z].hitCount){sliderBreak=replayFrame.t-replayOffset}}hitObject.object.scoreBreak=sliderBreak}}else{if(repeatCount>0){currentRepeat++;repeatCount--;replayFrame--;break}else{replayFrame++;break}}}if(hitObject.is_spinner){var centerPoint={x:osu.helpers.constants.OSU_GAME_WIDTH/2,y:osu.helpers.constants.OSU_GAME_HEIGHT/2};var angle=Math.atan2(centerPoint.y-(replayFrame.orig_y||replayFrame.y),centerPoint.x-(replayFrame.orig_x||replayFrame.x));if(keyDown){hitObject.object.rotations.push({a:angle,t:replayFrame.orig_t||replayFrame.t})}}}}return keyPresses};osu=osu||{};osu.GAMETYPES={NORMAL:0,TAIKO:1,CTB:2,MANIA:3};osu=osu||{};osu.helpers=osu.helpers||{};osu.helpers.constants=Object.freeze({OSU_GAME_HEIGHT:384,OSU_GAME_WIDTH:512,DOUBLE_TIME_MULTI:0.667,SLIDER_STEP_DISTANCE:5,TIMER_SONG_COLOUR:11842738,TIMER_INTRO_COLOUR:8583768});osu=osu||{};osu.helpers=osu.helpers||{};osu.helpers.math={distance:function distance(x1,y1,x2,y2){var v1=Math.abs(x1-x2);var v2=Math.abs(y1-y2);return Math.sqrt(v1*v1+v2*v2)},vectorDistance:function vectorDistance(v1,v2){return osu.helpers.math.distance(v1.x,v1.y,v2.x,v2.y)},angleVector:function angleVector(p1,p2){var xDiff=p2.x-p1.x;var yDiff=p2.y-p1.y;return Math.atan2(yDiff,xDiff)}};var osu=osu||{};osu.keypress=Object.freeze({KEYS:{NONE:0,M1:1,M2:2,K1:4,K2:8,SMOKE:16},get_keys:function get_keys(keys_int){var keys=[];if(keys_int==0){keys.push(this.KEYS.NONE);return keys}for(var k in this.KEYS){var bit=keys_int&this.KEYS[k];if(bit==this.KEYS[k]&&bit!=0){keys.push(this.KEYS[k])}}if(keys.indexOf(this.KEYS.M1)>-1&&keys.indexOf(this.KEYS.K1)>-1){keys.splice(keys.indexOf(this.KEYS.M1),1)}if(keys.indexOf(this.KEYS.M2)>-1&&keys.indexOf(this.KEYS.K2)>-1){keys.splice(keys.indexOf(this.KEYS.M2),1)}return keys}});var osu=osu||{};osu.mods=Object.freeze({__mods:{NONE:{value:0,multi:1,code:"",name:"No Mod",icon:""},NO_FAIL:{value:1,multi:0.5,code:"NF",name:"No Fail",icon:"selection_mod_nofail"},EASY:{value:2,multi:0.5,code:"EZ",name:"Easy",icon:"selection_mod_easy"},NO_VIDEO:{value:4,multi:1,code:"",name:"No Video",icon:""},HIDDEN:{value:8,multi:1.06,code:"HD",name:"Hidden",icon:"selection_mod_hidden"},HARD_ROCK:{value:16,multi:1.06,code:"HR",name:"Hard Rock",icon:"selection_mod_hardrock"},SUDDEN_DEATH:{value:32,multi:1,code:"SD",name:"Sudden Death",icon:"selection_mod_suddendeath"},DOUBLE_TIME:{value:64,multi:1.12,code:"DT",name:"Double Time",icon:"selection_mod_doubletime"},RELAX:{value:128,multi:0,code:"",name:"",icon:""},HALF_TIME:{value:256,multi:0.3,code:"HT",name:"Half Time",icon:"selection_mod_halftime"},NIGHT_CORE:{value:512,multi:1.12,code:"NT",name:"Night Core",icon:"selection_mod_nightcore"},FLASH_LIGHT:{value:1024,multi:1.12,code:"FL",name:"Flash Light",icon:"selection_mod_flashlight"},AUTO_PLAY:{value:2048,multi:0,code:"",name:"Auto Play",icon:""},SPUN_OUT:{value:4096,multi:0.9,code:"SO",name:"Spun Out",icon:"selection_mod_spunout"},RELAX_2:{value:8192,multi:0,code:"AP",name:"Auto Pilot",icon:""},PERFECT:{value:16384,multi:1,code:"PF",name:"Perfect",icon:"selection_mod_perfect"}},getMods:function getMods(mod_bit_int){var mods=[];if(mod_bit_int==0){mods.push(this.__mods.NONE);return mods}for(var k in this.__mods){var bit=mod_bit_int&this.__mods[k].value;if(bit==this.__mods[k].value){mods.push(this.__mods[k])}}return mods},getModFromVal:function getModFromVal(mod_int){for(var k in this.__mods){if(this.__mods[k].value==mod_int){return this.__mods[k]}}return{}}});osu=osu||{};osu.objects=osu.objects||{};osu.objects.Circle=function(){function Circle(hitObject){_classCallCheck(this,Circle);this.hitObject=hitObject;this.last_draw_time=0;this.drawn=false;this.destroyed=false;this.hidden_time=this.hitObject.approachRate/3.3;this.beenHit=false;this.isScoreAble=true;this.radius=0;this.missArray=[];this.hit_numbers={num_0:osu.skins.resources.default_0.texture,num_1:osu.skins.resources.default_1.texture,num_2:osu.skins.resources.default_2.texture,num_3:osu.skins.resources.default_3.texture,num_4:osu.skins.resources.default_4.texture,num_5:osu.skins.resources.default_5.texture,num_6:osu.skins.resources.default_6.texture,num_7:osu.skins.resources.default_7.texture,num_8:osu.skins.resources.default_8.texture,num_9:osu.skins.resources.default_9.texture}}_createClass(Circle,[{key:"reset",value:function reset(){this.last_draw_time=0;this.drawn=false;this.destroyed=false;this.beenHit=false;this.isScoreAble=true}},{key:"init",value:function init(){this.radius=this.hitObject.size/2;this.circleContainer=new PIXI.Container;this.endCircleSprite=new PIXI.Sprite(osu.skins.resources.hitcircle.texture);this.endCircleSprite.tint=this.hitObject.colour;this.endCircleSprite.anchor.set(0.5);this.endCircleSprite.height=this.hitObject.size;this.endCircleSprite.width=this.hitObject.size;this.radius=this.hitObject.size/2;if(!this.hitObject.game.is_hidden){this.approchCircleSprite=new PIXI.Sprite(osu.skins.resources.approachcircle.texture);this.approchCircleSprite.tint=this.hitObject.colour;this.approchCircleSprite.anchor.set(0.5);this.approchCircleSprite.width=this.hitObject.size*2.5;this.approchCircleSprite.height=this.hitObject.size*2.5;this.circleContainer.addChild(this.approchCircleSprite)}this.circleOverlaySprite=new PIXI.Sprite(osu.skins.resources.hitcicleoverlay.texture);this.circleOverlaySprite.height=this.hitObject.size;this.circleOverlaySprite.width=this.hitObject.size;this.circleOverlaySprite.anchor.set(0.5);this.circleContainer.addChild(this.endCircleSprite);this.circleContainer.addChild(this.circleOverlaySprite);var comboString=this.hitObject.combo.toString();this.comboNumSprites=[];for(var i=0;i<comboString.length;i++){this.comboNumSprites.push(new PIXI.Sprite(this.hit_numbers["num_"+comboString.charAt(i)]))}if(this.comboNumSprites.length>1){this.comboSprite1=this.comboNumSprites[0];this.comboSprite2=this.comboNumSprites[1];this.comboSprite1.x-=this.hitObject.size/10;this.comboSprite2.x+=this.hitObject.size/10;this.comboSprite1.anchor.set(0.5);this.comboSprite2.anchor.set(0.5);this.circleContainer.addChild(this.comboSprite1);this.circleContainer.addChild(this.comboSprite2)}else{this.comboSprite1=this.comboNumSprites[0];this.comboSprite1.anchor.set(0.5);this.circleContainer.addChild(this.comboSprite1)}this.circleContainer.x=this.hitObject.x;this.circleContainer.y=this.hitObject.y;this.hitSounds=osu.audio.HitSound.getHitSounds(this.hitObject.hitSounds,this.hitObject.timing)}},{key:"updatePositions",value:function updatePositions(){this.circleContainer.x=this.hitObject.x;this.circleContainer.y=this.hitObject.y}},{key:"draw",value:function draw(cur_time){if(cur_time>=this.hitObject.hitTime){this.hit(cur_time)}if(this.destroyed){if(!this.beenHit&&cur_time>this.hitObject.startTime+this.hitObject.hitOffset.HIT_50){if(this.isScoreAble)this.hitObject.ScorePoint.displayMiss();this.beenHit=true}return cur_time<this.hitObject.startTime+1000}if(this.drawn&&this.hitObject.game.is_hidden&&cur_time>this.hitObject.startTime-this.hidden_time){this.destroy();this.destroyed=true}if(!this.destroyed&&cur_time>this.hitObject.startTime+110){this.destroy();this.destroyed=true}if(!this.destroyed&&cur_time<this.hitObject.startTime+this.hitObject.approachRate){if(!this.hitObject.game.is_hidden){if(Date.now()-this.last_draw_time>35){var time_diff=this.hitObject.startTime-cur_time;var scale=1+time_diff/this.hitObject.approachRate*2.5;if(scale<1)scale=1;this.approchCircleSprite.width=this.hitObject.size*scale;this.approchCircleSprite.height=this.hitObject.size*scale;this.last_draw_time=Date.now()}}if(!this.drawn){this.hitObject.game.hit_object_container.addChildAt(this.circleContainer,0);this.drawn=true}}return true}},{key:"isInCircle",value:function isInCircle(pos){var hitCirclePos={x:this.hitObject.x,y:this.hitObject.y};var distance=osu.helpers.math.vectorDistance(hitCirclePos,pos);var result=distance<=this.radius;if(!result&&DEBUG)this.missArray.push("DISTANCE: "+distance+"RADIUS: "+this.radius+"DIFFERENCE: "+(distance-this.radius)+"STARTIME: "+this.hitObject.startTime+" X: "+hitCirclePos.x+" Y: "+hitCirclePos.y);return result}},{key:"playHitSound",value:function playHitSound(){for(var i=0;i<this.hitSounds.length;i++){osu.audio.sound.play_sound(this.hitSounds[i],this.hitObject.timing.volume/100)}}},{key:"hit",value:function hit(time,pos){if(this.beenHit){return}switch(this.hitObject.hitType){case"HIT_MISS":if(this.isScoreAble)this.hitObject.ScorePoint.displayMiss();this.beenHit=true;break;case"HIT_50":if(this.isScoreAble)this.hitObject.ScorePoint.display50();this.playHitSound();this.beenHit=true;break;case"HIT_100":if(this.isScoreAble)this.hitObject.ScorePoint.display100();this.playHitSound();this.beenHit=true;break;case"HIT_300":if(this.isScoreAble)this.hitObject.ScorePoint.display300();this.playHitSound();this.beenHit=true;break;}}},{key:"destroy",value:function destroy(){this.hitObject.game.hit_object_container.removeChild(this.circleContainer)}}]);return Circle}();osu=osu||{};osu.objects=osu.objects||{};osu.objects.curves=osu.objects.curves||{};osu.objects.curves.TYPES=Object.freeze({BEZIER:"B",LINEAR:"L",PASSTHROUGH:"P",CATMULL:"C"});osu.objects.Curve=function(){function Curve(hitObject){_classCallCheck(this,Curve);this.startPoint={x:hitObject.x,y:hitObject.y};this.controllPoints=hitObject.points;this.type=hitObject.sliderType;this.points=[];switch(this.type){case osu.objects.curves.TYPES.LINEAR:this.__generate_linear();break;case osu.objects.curves.TYPES.BEZIER:this.__generate_beizer();break;case osu.objects.curves.TYPES.PASSTHROUGH:this.__generate_passthrough();break;default:this.__generate_beizer();console.log("Unknown slider type");}for(var i=0;i<this.points.length-1;i++){var currentPoint=this.points[i];var nextPoint=this.points[i+1];var xDiff=nextPoint.x-currentPoint.x;var yDiff=nextPoint.y-currentPoint.y;var angle=Math.atan2(yDiff,xDiff);this.points[i].angle=angle;if(i+1==this.points.length-1){this.points[i+1].angle=angle}}}_createClass(Curve,[{key:"get_point",value:function get_point(t){var point=Math.round((this.points.length-1)*t);if(point>=this.points.length){return this.points[this.points.length-1]}return this.points[point]}},{key:"__generate_linear",value:function __generate_linear(){this.controllPoints.unshift(this.startPoint);this.__generate_beizer()}},{key:"__generate_beizer",value:function __generate_beizer(){var beziers=[];var cP=[];var lastP=false;for(var i=-1;i<this.controllPoints.length;i++){var tPos;if(i==-1){tPos=this.startPoint}else{tPos=this.controllPoints[i]}if(lastP&&tPos.x==lastP.x&&tPos.y==lastP.y){if(cP.length>1){beziers.push(new Bezier(cP))}cP.splice(0)}cP.push(tPos);lastP=tPos}if(cP.length>1){beziers.push(new Bezier(cP))}for(i=0;i<beziers.length;i++){var distance=0;var compute_value=0;var startingPoint=beziers[i].compute(0);var p=[startingPoint];while(distance<osu.helpers.constants.SLIDER_STEP_DISTANCE){compute_value+=0.00001;var point=beziers[i].compute(compute_value);distance=osu.helpers.math.distance(startingPoint.x,startingPoint.y,point.x,point.y)}var t=compute_value;while(t<=1){p.push(beziers[i].compute(t));t+=compute_value}if(t>1){p.push(beziers[i].compute(1))}this.points=this.points.concat(p)}}},{key:"__generate_passthrough",value:function __generate_passthrough(){var getPoint=function getPoint(angle,radius){var x=Math.cos(angle)*radius;var y=Math.sin(angle)*radius;return{x:x,y:y}};var lerp=function lerp(ang1,ang2,t){return ang1*(1-t)+ang2*t};var isMidBetween=function isMidBetween(a,b,c){return b>a&&b<c||b<a&&b>c};var circumcircle=function circumcircle(p1,p2,p3){var x,y,r;var A=p2.x-p1.x,B=p2.y-p1.y,C=p3.x-p1.x,D=p3.y-p1.y,E=A*(p1.x+p2.x)+B*(p1.y+p2.y),F=C*(p1.x+p3.x)+D*(p1.y+p3.y),G=2*(A*(p3.y-p2.y)-B*(p3.x-p2.x)),minx,miny,dx,dy;if(Math.abs(G)<0.000001){minx=Math.min(p1.x,p2.x,p3.x);miny=Math.min(p1.y,p2.y,p3.y);dx=(Math.max(p1.x,p2.x,p3.x)-minx)*0.5;dy=(Math.max(p1.y,p2.y,p3.y)-miny)*0.5;x=minx+dx;y=miny+dy;r=Math.sqrt(dx*dx+dy*dy)}else{x=(D*E-B*F)/G;y=(A*F-C*E)/G;dx=x-p1.x;dy=y-p1.y;r=Math.sqrt(dx*dx+dy*dy)}return{x:x,y:y,r:r}};var centerCircle=circumcircle(this.startPoint,this.controllPoints[0],this.controllPoints[1]);var xDiff=this.startPoint.x-centerCircle.x;var yDiff=this.startPoint.y-centerCircle.y;var startAngle=Math.atan2(yDiff,xDiff);xDiff=this.controllPoints[0].x-centerCircle.x;yDiff=this.controllPoints[0].y-centerCircle.y;var middleAngle=Math.atan2(yDiff,xDiff);xDiff=this.controllPoints[1].x-centerCircle.x;yDiff=this.controllPoints[1].y-centerCircle.y;var endAngle=Math.atan2(yDiff,xDiff);var TWO_PI=Math.PI*2;if(!isMidBetween(startAngle,middleAngle,endAngle)){if(Math.abs(startAngle+TWO_PI-endAngle)<TWO_PI&&isMidBetween(startAngle+TWO_PI,middleAngle,endAngle))startAngle+=TWO_PI;else if(Math.abs(startAngle-(endAngle+TWO_PI))<TWO_PI&&isMidBetween(startAngle,middleAngle,endAngle+TWO_PI))endAngle+=TWO_PI;else if(Math.abs(startAngle-TWO_PI-endAngle)<TWO_PI&&isMidBetween(startAngle-TWO_PI,middleAngle,endAngle))startAngle-=TWO_PI;else if(Math.abs(startAngle-(endAngle-TWO_PI))<TWO_PI&&isMidBetween(startAngle,middleAngle,endAngle-TWO_PI))endAngle-=TWO_PI;else console.log("Cannot find angles between midAng "+startAngle+" "+middleAngle+" "+endAngle)}var t=0;while(t<=1){var angle=lerp(startAngle,endAngle,t);var point=getPoint(angle,centerCircle.r);point.x+=centerCircle.x;point.y+=centerCircle.y;this.points.push(point);t+=0.01}}}]);return Curve}();osu=osu||{};osu.objects=osu.objects||{};osu.objects.FollowPoint=function(){function FollowPoint(hitObject1,hitObject2){_classCallCheck(this,FollowPoint);this.hitObject1=hitObject1;this.hitObject2=hitObject2;this.drawn=false;this.destroyed=false}_createClass(FollowPoint,[{key:"init",value:function init(){this.x1=this.hitObject1.endX||this.hitObject1.x;this.y1=this.hitObject1.endY||this.hitObject1.y;this.x2=this.hitObject2.x;this.y2=this.hitObject2.y;this.drawTime=this.hitObject1.endTime||this.hitObject1.startTime;this.drawTime-=this.hitObject1.approachRate/2;var xDiff=this.x2-this.x1;var yDiff=this.y2-this.y1;var angle=Math.atan2(yDiff,xDiff);var distance=osu.helpers.math.distance(this.x1,this.y1,this.x2,this.y2);var numPoints=Math.round(distance/(this.hitObject1.size/1.5));var steps=1/(numPoints+1);var nextStep=steps;this.followPointContainer=new PIXI.Container;var arrowTexture=osu.skins.resources.followpoint.texture;for(var i=0;i<numPoints;i++){var arrowSprite=new PIXI.Sprite(arrowTexture);arrowSprite.rotation=angle;arrowSprite.position.x=this.x1+xDiff*nextStep;arrowSprite.position.y=this.y1+yDiff*nextStep;this.followPointContainer.addChild(arrowSprite);nextStep+=steps}}},{key:"reset",value:function reset(){this.destroyed=false;this.drawn=false}},{key:"draw",value:function draw(cur_time){if(this.destroyed){return false}if(!this.drawn&&cur_time>=this.drawTime){this.hitObject1.game.hit_object_container.addChildAt(this.followPointContainer,0);this.drawn=true;return true}if(!this.destroyed&&cur_time>this.hitObject2.startTime){this.destroy();this.destroyed=true}return true}},{key:"destroy",value:function destroy(){this.hitObject1.game.hit_object_container.removeChild(this.followPointContainer)}}]);return FollowPoint}();osu=osu||{};osu.objects=osu.objects||{};osu.objects.HitObjectParser={TYPES:{CIRCLE:1,SLIDER:2,NEW_COMBO:4,SPINNER:8},HIT_SOUNDS:{SOUND_NORMAL:0,SOUND_WHISTLE:2,SOUND_FINISH:4,SOUND_CLAP:8},HIT_ADDITIONS:{NORMAL:1,SOFT:2,DRUM:3},parse_type:function parse_type(hitObjectInt){var newCombo=false;if(hitObjectInt&this.TYPES.NEW_COMBO){newCombo=true}if(hitObjectInt&osu.objects.HitObjectParser.TYPES.CIRCLE){return{type:this.TYPES.CIRCLE,new_combo:newCombo}}if(hitObjectInt&osu.objects.HitObjectParser.TYPES.SLIDER){return{type:this.TYPES.SLIDER,new_combo:newCombo}}if(hitObjectInt&osu.objects.HitObjectParser.TYPES.SPINNER){return{type:this.TYPES.SPINNER,new_combo:newCombo}}},parse_line:function parse_line(line,timing,sliderMulti){var get_timing_point=function get_timing_point(offset){for(var i=timing.length-1;i>=0;i--){if(timing[i].offset<=offset)return timing[i]}return timing[0]};var parse_additions=function parse_additions(strAdditions){if(!strAdditions)return{};var additions={};var adds=strAdditions.split(":");if(adds.length>0){additions.sample=+adds[0]}if(adds.length>1){additions.additionalSample=+adds[1]}if(adds.length>2){additions.customSampleIndex=+adds[2]}if(adds.length>3){additions.hitSoundVolume=+adds[3]}if(adds.length>4){additions.hitsound=+adds[4]}return additions};var hitObject={};var hitArray=line.split(",");var type=this.parse_type(+hitArray[3]);hitObject.x=+hitArray[0];hitObject.y=+hitArray[1];hitObject.startTime=+hitArray[2];hitObject.type=type.type;hitObject.newCombo=type.new_combo;hitObject.hitSounds=[];hitObject.timing=get_timing_point(hitObject.startTime);hitObject.is_slider=false;hitObject.is_circle=false;hitObject.is_spinner=false;var soundByte=+hitArray[4];if((soundByte&this.HIT_SOUNDS.SOUND_WHISTLE)==this.HIT_SOUNDS.SOUND_WHISTLE)hitObject.hitSounds.push(this.HIT_SOUNDS.SOUND_WHISTLE);if((soundByte&this.HIT_SOUNDS.SOUND_FINISH)==this.HIT_SOUNDS.SOUND_FINISH)hitObject.hitSounds.push(this.HIT_SOUNDS.SOUND_FINISH);if((soundByte&this.HIT_SOUNDS.SOUND_CLAP)==this.HIT_SOUNDS.SOUND_CLAP)hitObject.hitSounds.push(this.HIT_SOUNDS.SOUND_CLAP);if(hitObject.hitSounds.length===0)hitObject.hitSounds.push(this.HIT_SOUNDS.SOUND_NORMAL);if(hitObject.type==this.TYPES.CIRCLE){hitObject.is_circle=true;hitObject.additions=parse_additions(hitArray[5])}if(hitObject.type==this.TYPES.SPINNER){hitObject.is_spinner=true;hitObject.endTime=+hitArray[5];hitObject.additions=+hitArray[6]}if(hitObject.type==this.TYPES.SLIDER){hitObject.is_slider=true;var sliderData=hitArray[5].split("|");hitObject.sliderType=sliderData[0];hitObject.repeatCount=+hitArray[6];hitObject.pixelLength=+hitArray[7];hitObject.additions=parse_additions(hitArray[10]);hitObject.edges=[];var sounds=[];var additions=[];if(hitArray[8])sounds=hitArray[8].split("|");if(hitArray[9])additions=hitArray[9].split("|");for(var x=0;x<hitObject.repeatCount+1;x++){var edge={sounds:[],additions:parse_additions(additions[x])};if(sounds[x]){soundByte=sounds[x];if((soundByte&this.HIT_SOUNDS.SOUND_WHISTLE)==this.HIT_SOUNDS.SOUND_WHISTLE)edge.sounds.push(this.HIT_SOUNDS.SOUND_WHISTLE);if((soundByte&this.HIT_SOUNDS.SOUND_FINISH)==this.HIT_SOUNDS.SOUND_FINISH)edge.sounds.push(this.HIT_SOUNDS.SOUND_FINISH);if((soundByte&this.HIT_SOUNDS.SOUND_CLAP)==this.HIT_SOUNDS.SOUND_CLAP)edge.sounds.push(this.HIT_SOUNDS.SOUND_CLAP);if(hitObject.hitSounds.length===0)edge.sounds.push(this.HIT_SOUNDS.SOUND_NORMAL)}else{edge.sounds.push(this.HIT_SOUNDS.SOUND_NORMAL)}hitObject.edges.push(edge)}hitObject.points=[];for(var i=1;i<sliderData.length;i++){var points=sliderData[i].split(":");hitObject.points.push({x:+points[0],y:+points[1]})}var beats=hitObject.pixelLength*hitObject.repeatCount/(100*sliderMulti);hitObject.duration=Math.ceil(beats*hitObject.timing.millisecondsPerBeat);hitObject.endTime=hitObject.startTime+hitObject.duration}return hitObject},create_stacks:function create_stacks(hitobjects,stackLeniency,circleSize,hardrock){for(var i=hitobjects.length-1;i>0;i--){var hitObjectI=hitobjects[i];if(hitObjectI.stack!=0||hitObjectI.type==osu.objects.HitObjectParser.TYPES.SPINNER)continue;if(hitObjectI.type==osu.objects.HitObjectParser.TYPES.CIRCLE){for(var n=i-1;n>=0;n--){var hitObjectN=hitobjects[n];if(hitObjectN.type==osu.objects.HitObjectParser.TYPES.SPINNER)continue;var timeI=hitObjectI.startTime-1000*stackLeniency;var timeN=hitObjectN.startTime;if(timeI>timeN)break;var distance=osu.helpers.math.distance(hitObjectI.x,hitObjectI.y,hitObjectN.x,hitObjectN.y);if(distance<3){hitObjectN.stack=hitObjectI.stack+1;hitObjectI=hitObjectN}}}}for(i=0;i<hitobjects.length;i++){var hitObject=hitobjects[i];var stack=hitObject.stack;var offset=stack*(circleSize*0.05);var x=hitObject.x-offset;var y=hitObject.y-offset;if(hardrock)y=y+offset;hitObject.x=x;hitObject.y=y}},initialiseHitObjects:function initialiseHitObjects(hitobjects){for(var i=0;i<hitobjects.length;i++){hitobjects[i].init()}},calculate_follow_points:function calculate_follow_points(hitobjects,game){for(var i=0;i<hitobjects.length-1;i++){var hitObject1=hitobjects[i];var hitObject2=hitobjects[i+1];if(hitObject1.type==osu.objects.HitObjectParser.TYPES.SPINNER)continue;if(hitObject2.type==osu.objects.HitObjectParser.TYPES.SPINNER)continue;if(hitObject2.newCombo)continue;var startX=game.calculate_original_x(hitObject1.endX||hitObject1.x);var startY=game.calculate_original_y(hitObject1.endY||hitObject1.y);var endX=game.calculate_original_x(hitObject2.x);var endY=game.calculate_original_y(hitObject2.y);var distance=osu.helpers.math.distance(startX,startY,endX,endY);if(distance>50){hitObject1.followPoint=new osu.objects.FollowPoint(hitObject1,hitObject2);hitObject1.followPoint.init()}}}};osu=osu||{};osu.objects=osu.objects||{};osu.objects.HitObject=function(){function HitObject(hitObjectData,size,approachRate,game){_classCallCheck(this,HitObject);this._x=0;this._y=0;this.game=game||false;this.combo=1;this.colour=16777215;this.stack=0;this.size=size;this.approachRate=approachRate;this.followPoint=false;this.drawn=false;this.hitOffset={HIT_300:79.5,HIT_100:139.5,HIT_50:199.5,HIT_MISS:500};this.destroyed=false;$.extend(this,hitObjectData);this.hitType="HIT_MISS";this.hitTime=this.startTime;if(this.game&&this.game.is_hardrock)this._y=384-this._y;switch(this.type){case osu.objects.HitObjectParser.TYPES.CIRCLE:this.object=new osu.objects.Circle(this);break;case osu.objects.HitObjectParser.TYPES.SLIDER:this.object=new osu.objects.Slider(this);break;case osu.objects.HitObjectParser.TYPES.SPINNER:this.object=new osu.objects.Spinner(this);}this.initialised=false}_createClass(HitObject,[{key:"init",value:function init(){if(!this.game){throw"Cannot Intialise object without game object!"}this.x=this.game.calculate_x(this.x);this.y=this.game.calculate_y(this.y);this.drawn=false;if(this.game.is_doubletime){this.startTime*=osu.helpers.constants.DOUBLE_TIME_MULTI;if(this.endTime)this.endTime*=osu.helpers.constants.DOUBLE_TIME_MULTI;this.hitTime*=osu.helpers.constants.DOUBLE_TIME_MULTI}this.object.init();this.ScorePoint=new osu.objects.ScorePoint(this.endX||this.x,this.endY||this.y,this.game);this.initialised=true}},{key:"reset",value:function reset(){this.destroyed=false;this.drawn=false;this.object.reset();if(this.followPoint){this.followPoint.reset()}}},{key:"destroy",value:function destroy(){this.destroyed=true}},{key:"draw",value:function draw(cur_time){if(this.destroyed)return false;if(!this.drawn){this.game.hit_object_container.addChild(this.ScorePoint.getContainer());this.drawn=true}var followResult=false;if(this.followPoint){followResult=this.followPoint.draw(cur_time)}var drawResult=this.object.draw(cur_time);if(!drawResult){this.game.hit_object_container.removeChild(this.ScorePoint.getContainer())}return drawResult||followResult}},{key:"hit",value:function hit(cur_time,pos){return this.object.hit(cur_time,pos)}},{key:"x",set:function set(v){this._x=v;if(this.initialised)this.object.updatePositions()},get:function get(){return this._x}},{key:"y",set:function set(v){this._y=v;if(this.initialised)this.object.updatePositions()},get:function get(){return this._y}}]);return HitObject}();osu=osu||{};osu.objects=osu.objects||{};osu.objects.ScorePoint=function(){function ScorePoint(x,y,game){_classCallCheck(this,ScorePoint);this.game=game;this.hit300Sprite=new PIXI.Sprite(osu.skins.resources.hit300_0&&osu.skins.resources.hit300_0.texture||osu.skins.resources.hit300.texture);this.hit100Sprite=new PIXI.Sprite(osu.skins.resources.hit100_0&&osu.skins.resources.hit100_0.texture||osu.skins.resources.hit100.texture);this.hit50Sprite=new PIXI.Sprite(osu.skins.resources.hit50_0&&osu.skins.resources.hit50_0.texture||osu.skins.resources.hit50.texture);this.hitMissSprite=new PIXI.Sprite(osu.skins.resources.hit0_0&&osu.skins.resources.hit0_0.texture||osu.skins.resources.hit0.texture);this.hit300Sprite.visible=false;this.hit100Sprite.visible=false;this.hit50Sprite.visible=false;this.hitMissSprite.visible=false;this.hitContainer=new PIXI.Container;this.hitContainer.addChild(this.hit300Sprite);this.hitContainer.addChild(this.hit100Sprite);this.hitContainer.addChild(this.hit50Sprite);this.hitContainer.addChild(this.hitMissSprite);this.hitContainer.position.x=x;this.hitContainer.position.y=y}_createClass(ScorePoint,[{key:"getContainer",value:function getContainer(){return this.hitContainer}},{key:"display300",value:function display300(){this.hit300Sprite.visible=true;this.game.performance.add300()}},{key:"display100",value:function display100(){this.hit100Sprite.visible=true;this.game.performance.add100()}},{key:"display50",value:function display50(){this.hit50Sprite.visible=true;this.game.performance.add50()}},{key:"displayMiss",value:function displayMiss(){this.hitMissSprite.visible=true;this.game.performance.addMiss()}}]);return ScorePoint}();osu=osu||{};osu.objects=osu.objects||{};osu.objects.Slider=function(){function Slider(hitObject){_classCallCheck(this,Slider);if(!osu.objects.ballTextures){osu.objects.ballTextures=[];if(osu.skins.resources.sliderb0){for(var i=0;i<99;i++){if(osu.skins.resources["sliderb"+i]){osu.objects.ballTextures.push(osu.skins.resources["sliderb"+i].texture)}else{break}}}}this.hitObject=hitObject;this.last_draw_time=0;this.drawn=false;this.destroyed=false;this.initialised=false;this.originalX=this.hitObject.x;this.originalY=this.hitObject.y;this.hidden_time=this.hitObject.approachRate/3.3;this.sliderDirectionBackwards=false;this.drawnFollow=false;this.totalTime=this.hitObject.endTime-this.hitObject.startTime;this.timePerRepeat=this.totalTime/this.hitObject.repeatCount;this.nextRepeatTime=0;this.hitSounds=[];this.repeatCount=this.hitObject.repeatCount;var points=this.hitObject.points;if(this.hitObject.game.is_hardrock){for(var i=0;i<points.length;i++){points[i].y=osu.helpers.constants.OSU_GAME_HEIGHT-points[i].y}}this.curves=new osu.objects.Curve(this.hitObject);this.ticks=[];this.tickPositions=[];var tickLengthDiv=this.hitObject.timing.millisecondsPerBeat/this.hitObject.game.sliderMultiplier/this.hitObject.game.sliderTickRate;var sliderDuration=this.hitObject.duration/this.hitObject.repeatCount;var tickCount=Math.ceil(sliderDuration/tickLengthDiv)-1;if(tickCount>0){var tickTOffset=1/(tickCount+1);var t=tickTOffset;for(i=0;i<tickCount;i++,t+=tickTOffset){this.ticks.push(t)}for(i=0;i<this.ticks.length;i++){var tickLoc=this.curves.get_point(this.ticks[i]);this.tickPositions.push(tickLoc)}}this.scoreBreak=false}_createClass(Slider,[{key:"reset",value:function reset(){this.beenHit=false;this.nextRepeatTime=0;this.sliderDirectionBackwards=false;this.repeatCount=this.hitObject.repeatCount;this.startCircle.reset();this.startCircle.isScoreAble=false;this.drawnFollow=false;this.drawn=false;this.destroyed=false;this.last_draw_time=0;this.hitSounds=[];for(var i=0;i<this.hitObject.edges.length;i++){this.hitSounds.push(osu.audio.HitSound.getHitSounds(this.hitObject.edges[i].sounds,this.hitObject.timing,i==0))}}},{key:"init",value:function init(){this.beenHit=false;this.nextRepeatTime=0;this.sliderDirectionBackwards=false;this.repeatCount=this.hitObject.repeatCount;this.startCircle=new osu.objects.Circle(this.hitObject);this.startCircle.isScoreAble=false;this.startCircle.init();this.drawnFollow=false;this.drawn=false;this.destroyed=false;this.last_draw_time=0;if(this.initialised)return;var sliderGraphics=new PIXI.Graphics;var points=this.hitObject.points;for(var i=0;i<points.length;i++){points[i].x=this.hitObject.game.calculate_x(points[i].x);points[i].y=this.hitObject.game.calculate_y(points[i].y)}sliderGraphics.beginFill(this.hitObject.colour);sliderGraphics.lineStyle(5,16777215);var final_x=points[points.length-1].x;var final_y=points[points.length-1].y;this.hitObject.endX=final_x;this.hitObject.endY=final_y;sliderGraphics.endFill();this.curves=new osu.objects.Curve(this.hitObject);sliderGraphics.lineStyle(5,16777215);sliderGraphics.beginFill(16777215);var lastPoint=this.curves.points[0];sliderGraphics.drawCircle(lastPoint.x,lastPoint.y,this.hitObject.size/2.15);var distance=osu.helpers.math.vectorDistance;for(var i=1;i<this.curves.points.length;i++){var drawPoint=this.curves.points[i];if(distance(lastPoint,drawPoint)>this.hitObject.size/15){lastPoint=drawPoint;sliderGraphics.drawCircle(drawPoint.x,drawPoint.y,this.hitObject.size/2.15)}}var finalPoint=this.curves.points[this.curves.points.length-1];sliderGraphics.drawCircle(finalPoint.x,finalPoint.y,this.hitObject.size/2.15);sliderGraphics.lineStyle(5,this.hitObject.colour);sliderGraphics.beginFill(this.hitObject.colour);lastPoint=this.curves.points[0];sliderGraphics.drawCircle(lastPoint.x,lastPoint.y,this.hitObject.size*0.9/2.15);for(var i=1;i<this.curves.points.length;i++){drawPoint=this.curves.points[i];if(distance(lastPoint,drawPoint)>this.hitObject.size/15){lastPoint=drawPoint;sliderGraphics.drawCircle(drawPoint.x,drawPoint.y,this.hitObject.size*0.9/2.15)}}finalPoint=this.curves.points[this.curves.points.length-1];sliderGraphics.drawCircle(finalPoint.x,finalPoint.y,this.hitObject.size*0.9/2.15);var t=sliderGraphics.generateTexture();var sprite=new PIXI.Sprite(t);sprite.position.x=sliderGraphics.getBounds().x;sprite.position.y=sliderGraphics.getBounds().y;sprite.alpha=0.6;sprite.cacheAsBitmap=true;sliderGraphics.clear();sliderGraphics.destroy();this.sliderGraphicsContainer=new PIXI.Container;this.sliderGraphicsContainer.addChild(sprite);this.endCircleSprite=new PIXI.Sprite(osu.skins.resources.hitcicleoverlay.texture);this.endCircleSprite.anchor.set(0.5);this.endCircleSprite.height=this.hitObject.size;this.endCircleSprite.width=this.hitObject.size;this.endCircleSprite.position.x=final_x;this.endCircleSprite.position.y=final_y;this.sliderGraphicsContainer.addChild(this.endCircleSprite);this.startCircleSprite=new PIXI.Sprite(osu.skins.resources.hitcicleoverlay.texture);this.startCircleSprite.anchor.set(0.5);this.startCircleSprite.height=this.hitObject.size;this.startCircleSprite.width=this.hitObject.size;this.startCircleSprite.position.x=this.hitObject.x;this.startCircleSprite.position.y=this.hitObject.y;this.sliderGraphicsContainer.addChild(this.startCircleSprite);this.arrowSliderEnd=new PIXI.Sprite(osu.skins.resources.reversearrow.texture);this.arrowSliderEnd.height=this.hitObject.size*2/5;this.arrowSliderEnd.width=this.hitObject.size*2/5;this.arrowSliderEnd.anchor.set(0.5);this.arrowSliderEnd.position.x=final_x;this.arrowSliderEnd.position.y=final_y;var angle=osu.helpers.math.angleVector(this.curves.points[this.curves.points.length-1],this.curves.points[this.curves.points.length-2]);this.arrowSliderEnd.rotation=angle;this.arrowSliderEnd.visible=false;this.arrowSliderStart=new PIXI.Sprite(osu.skins.resources.reversearrow.texture);this.arrowSliderStart.height=this.hitObject.size*2/5;this.arrowSliderStart.width=this.hitObject.size*2/5;this.arrowSliderStart.anchor.set(0.5);this.arrowSliderStart.position.x=this.hitObject.x;this.arrowSliderStart.position.y=this.hitObject.y;angle=osu.helpers.math.angleVector(this.curves.points[0],this.curves.points[1]);this.arrowSliderStart.rotation=angle;this.arrowSliderStart.visible=false;this.sliderGraphicsContainer.addChild(this.arrowSliderStart);this.sliderGraphicsContainer.addChild(this.arrowSliderEnd);this.tickPositions=[];for(i=0;i<this.ticks.length;i++){var tickLoc=this.curves.get_point(this.ticks[i]);this.tickPositions.push(tickLoc);var tickSprite=new PIXI.Sprite(osu.skins.resources.sliderscorepoint.texture);tickSprite.position.x=tickLoc.x;tickSprite.position.y=tickLoc.y;tickSprite.anchor.set(0.5);this.sliderGraphicsContainer.addChild(tickSprite)}this.sliderFollowContainer=new PIXI.Container;var sliderFollowSprite=new PIXI.Sprite(osu.skins.resources.sliderfollowcircle.texture);sliderFollowSprite.height=this.hitObject.size*2;sliderFollowSprite.width=this.hitObject.size*2;sliderFollowSprite.anchor.set(0.5);var sliderBall=new PIXI.extras.MovieClip(osu.objects.ballTextures);sliderBall.animationSpeed=1.2;sliderBall.anchor.set(0.5);sliderBall.width=this.hitObject.size;sliderBall.height=this.hitObject.size;sliderBall.play();this.sliderFollowContainer.addChild(sliderFollowSprite);this.sliderFollowContainer.addChild(sliderBall);this.sliderFollowContainer.position.x=this.hitObject.x;this.sliderFollowContainer.position.y=this.hitObject.y;for(i=0;i<this.hitObject.edges.length;i++){this.hitSounds.push(osu.audio.HitSound.getHitSounds(this.hitObject.edges[i].sounds,this.hitObject.timing,i==0))}this.initialised=true}},{key:"updatePositions",value:function updatePositions(){this.startCircle.updatePositions();var moveX=this.originalX-this.hitObject.x;var moveY=this.originalY-this.hitObject.y;this.sliderGraphicsContainer.x-=moveX;this.sliderGraphicsContainer.y-=moveY;this.originalX=this.hitObject.x;this.originalY=this.hitObject.y}},{key:"hit",value:function hit(time){var playSound=false;if(time>=this.hitObject.startTime&&this.hitSounds.length==this.hitObject.edges.length){playSound=true}if(this.nextRepeatTime==0){if(time>=this.hitObject.endTime){playSound=true}}else{if(time>=this.nextRepeatTime+this.hitObject.startTime){playSound=true}}if(playSound&&this.hitSounds.length>0){var sounds=this.hitSounds.shift();for(var i=0;i<sounds.length;i++){osu.audio.sound.play_sound(sounds[i],this.hitObject.timing.volume/100)}}}},{key:"draw",value:function draw(cur_time){this.hit(cur_time);var drawCircle=this.startCircle.draw(cur_time);if(this.destroyed&&!drawCircle){if(cur_time>this.hitObject.endTime+500){return false}}if(this.drawn&&this.hitObject.game.is_hidden&&cur_time>this.hitObject.startTime-this.hidden_time){this.destroy();this.destroyed=true}if(!this.beenHit&&this.scoreBreak&&this.scoreBreak>cur_time){this.hitObject.ScorePoint.displayMiss();this.beenHit=true}if(!this.beenHit&&!this.scoreBreak&&cur_time>this.hitObject.endTime){switch(this.hitObject.hitType){case"HIT_MISS":this.hitObject.ScorePoint.displayMiss();this.beenHit=true;break;case"HIT_50":this.hitObject.ScorePoint.display50();this.beenHit=true;break;case"HIT_100":this.hitObject.ScorePoint.display100();this.beenHit=true;break;case"HIT_300":this.hitObject.ScorePoint.display300();this.beenHit=true;break;}}if(cur_time>=this.hitObject.startTime){if(!this.drawnFollow){this.hitObject.game.hit_object_container.addChild(this.sliderFollowContainer)}if(this.repeatCount>0){var elapsed_time=cur_time-this.nextRepeatTime-this.hitObject.startTime;if(this.repeatCount%2==0){this.arrowSliderEnd.visible=true;this.arrowSliderStart.visible=false}else{this.arrowSliderEnd.visible=false;if(this.repeatCount!=1){this.arrowSliderStart.visible=true}}var t=elapsed_time/this.timePerRepeat;if(this.sliderDirectionBackwards){t=1-t}if(t>=1||t<0){this.repeatCount-=1;this.nextRepeatTime+=this.timePerRepeat;this.sliderDirectionBackwards=!this.sliderDirectionBackwards;t=1}var moveTo=this.curves.get_point(t);this.sliderFollowContainer.position.x=moveTo.x;this.sliderFollowContainer.position.y=moveTo.y;this.sliderFollowContainer.rotation=moveTo.angle}else{this.hitObject.game.hit_object_container.removeChild(this.sliderFollowContainer)}}if(!this.drawn){this.hitObject.game.hit_object_container.addChildAt(this.sliderGraphicsContainer,0);this.drawn=true}if(!this.destroyed&&cur_time>this.hitObject.endTime+110){this.destroy();this.destroyed=true}return true}},{key:"destroy",value:function destroy(){this.destroyed=true;this.hitObject.game.hit_object_container.removeChild(this.sliderGraphicsContainer)}}]);return Slider}();osu=osu||{};osu.objects=osu.objects||{};osu.objects.Smoke=function(x,y){var sprite=new PIXI.Sprite(osu.skins.resources.cursor_smoke.texture);sprite.position.x=x;sprite.position.y=y;sprite.anchor.set(0.5);sprite.destroyer=function(){var self=this;setTimeout(function(){self.visible=false},3500)};sprite.destroyer();return sprite};osu=osu||{};osu.objects=osu.objects||{};osu.objects.Spinner=function(){function Spinner(hitObject){_classCallCheck(this,Spinner);this.hitObject=hitObject;this.drawn=false;this.destroyed=false;this.rotations=[];this.currentRotation=0}_createClass(Spinner,[{key:"reset",value:function reset(){this.drawn=false;this.destroyed=false;this.beenHit=false;this.isScoreAble=true;this.currentRotation=0}},{key:"init",value:function init(){this.drawn=false;this.destroyed=false;this.x=this.hitObject.game.getRenderWidth()/2;this.y=this.hitObject.game.getRenderHeight()/2;this.spinnerContainer=new PIXI.Container;var backgroundSprite=new PIXI.Sprite(osu.skins.resources.spinner_background.texture);backgroundSprite.width=this.hitObject.game.getRenderWidth();backgroundSprite.height=this.hitObject.game.getRenderHeight();this.spinnerCirle=new PIXI.Sprite(osu.skins.resources.spinner_circle.texture);this.spinnerCirle.position.x=this.x;this.spinnerCirle.position.y=this.y;this.spinnerCirle.anchor.set(0.5);this.spinnerContainer.addChild(backgroundSprite);this.spinnerContainer.addChild(this.spinnerCirle)}},{key:"draw",value:function draw(cur_time){if(!this.drawn){if(cur_time>this.hitObject.startTime){this.hitObject.game.hit_object_container.addChild(this.spinnerContainer);this.drawn=true}}if(!this.destroyed){if(this.rotations.length===0){this.spinnerCirle.rotation-=0.1}else{for(var i=this.currentRotation;i<this.rotations.length;i++){if(this.rotations[i].t<=cur_time){this.currentRotation=i;this.spinnerCirle.rotation=this.rotations[i].a}else{break}}}if(cur_time>this.hitObject.endTime){this.destroy();this.destroyed=true}}return!this.destroyed}},{key:"destroy",value:function destroy(){this.hitObject.game.hit_object_container.removeChild(this.spinnerContainer)}}]);return Spinner}();var osu=osu||{};osu.score={GRADES:Object.freeze({SS:{name:"SS",small_icn:"ranking_x_small",large_icn:"ranking_x"},S:{name:"S",small_icn:"ranking_s_small",large_icn:"ranking_s"},A:{name:"A",small_icn:"ranking_a_small",large_icn:"ranking_a"},B:{name:"B",small_icn:"ranking_b_small",large_icn:"ranking_b"},C:{name:"C",small_icn:"ranking_c_small",large_icn:"ranking_c"},D:{name:"D",small_icn:"ranking_d_small",large_icn:"ranking_d"},SSH:{name:"SSH",small_icn:"ranking_xh_small",large_icn:"ranking_xh"},SH:{name:"SH",small_icn:"ranking_sh_small",large_icn:"ranking_sh"}}),getGrade:function getGrade(h300,h100,h50,hMisses,mods){var is_silver=false;for(var i=0;i<mods.length;i++){if(mods[i].code=="FL"||mods[i].code=="HD"){is_silver=true}}var total_hits=h300+h100+h50+hMisses;if(h300==total_hits){if(is_silver)return this.GRADES.SSH;else return this.GRADES.SS}if(h300/total_hits*100>90){if(hMisses>0||h50/total_hits*100>1){return this.GRADES.A}if(is_silver)return this.GRADES.SH;else return this.GRADES.S}if(h300/total_hits*100>80){if(hMisses>0){return this.GRADES.B}return this.GRADES.A}if(h300/total_hits*100>70){if(hMisses>0){return this.GRADES.C}return this.GRADES.B}if(h300/total_hits*100>60){return this.GRADES.C}return this.GRADES.D},getAccuracy:function getAccuracy(h300,h100,h50,hMisses){var maxHits=h300+h100+h50+hMisses;var percent=(h300*300+h100*100+h50*50)/(maxHits*300)*100;return parseFloat(percent).toFixed(2)},parseAccuracyFromReplay:function parseAccuracyFromReplay(replay){return this.getAccuracy(replay.h300+replay.hGekis,replay.h100+replay.hKatus,replay.h50,replay.hMisses)}};osu=osu||{};osu.settings={DEFAULTS:Object.freeze({background_dim:0.5,master_volume:1,music_volume:0.5,sound_effects:0.4,use_beatmap_skins:false,use_beatmap_hitsounds:false,song_url:false,asset_server:false,selected_skin:"0"}),SETTINGS:{_background_dim:0.3,_master_volume:1,_music_volume:0.5,_sound_effects_volume:0.4,_use_beatmap_skins:false,_use_beatmap_hitsounds:false,_song_url:false,_asset_server:false,_selected_skin:"0",get background_dim(){return this._background_dim},set background_dim(v){this._background_dim=v;event_handler.emit(event_handler.EVENTS.SETTINGS_CHANGED)},get master_volume(){return this._master_volume},set master_volume(v){this._master_volume=v;event_handler.emit(event_handler.EVENTS.SETTINGS_CHANGED)},get music_volume(){return this._music_volume},set music_volume(v){this._music_volume=v;event_handler.emit(event_handler.EVENTS.SETTINGS_CHANGED)},get sound_effects_volume(){return this._sound_effects_volume},set sound_effects_volume(v){this._sound_effects_volume=v;event_handler.emit(event_handler.EVENTS.SETTINGS_CHANGED)},get use_beatmap_skins(){return this._use_beatmap_skins},set use_beatmap_skins(v){this._use_beatmap_skins=v;event_handler.emit(event_handler.EVENTS.SETTINGS_CHANGED)},get use_beatmap_hitsounds(){return this._use_beatmap_hitsounds},set use_beatmap_hitsounds(v){this._use_beatmap_hitsounds=v;event_handler.emit(event_handler.EVENTS.SETTINGS_CHANGED)},get song_url(){return this._song_url},set song_url(v){this._song_url=v;event_handler.emit(event_handler.EVENTS.SETTINGS_CHANGED)},get asset_server(){return this._asset_server},set asset_server(v){this._asset_server=v;event_handler.emit(event_handler.EVENTS.SETTINGS_CHANGED)},get selected_skin(){return this._selected_skin},set selected_skin(v){this._selected_skin=v;event_handler.emit(event_handler.EVENTS.SETTINGS_CHANGED)}},init:function init(){var self=this;event_handler.on(event_handler.EVENTS.SETTINGS_CHANGED,this.save_settings.bind(this));database.get_data(database.TABLES.OPTIONS,"options",function(e){if(e.data){for(var k in e.data){if(e.data.hasOwnProperty(k)){if(k.indexOf("_")==0){self.SETTINGS[k]=e.data[k]}}}}self.onloaded();event_handler.emit(event_handler.EVENTS.SETTINGS_CHANGED)})},save_settings:function save_settings(){database.update_data(database.TABLES.OPTIONS,"options",this.SETTINGS)},onloaded:function onloaded(){}};var osu=osu||{};osu.ui=osu.ui||{};osu.ui.interface=osu.ui.interface||{};osu.ui.interface.mainscreen={beatmap_count:-1,replay_count:-1,key_count:0,processed_count:0,displaying_main_screen:false,loaded:false,beatmap_keys:[],beatmaps:[],current_selection:false,beatmap_selection_template:"",replay_selection_template:"",$beatmap_section_html:null,$replay_section_html:null,cached_dom:false,events_bound:false,replays:[],beatmapSearch:null,replaySearch:null,$currentSelectionHtml:"",init:function init(){this.cacheDom();this.bind_events();this.$master_volume_slider.val(osu.settings.SETTINGS.master_volume*100);this.$music_volume_slider.val(osu.settings.SETTINGS.music_volume*100);this.$sound_volume_slider.val(osu.settings.SETTINGS.sound_effects_volume*100);this.$background_dim_slider.val(osu.settings.SETTINGS.background_dim*100);this.$skin_select.val(osu.settings.SETTINGS.selected_skin);var self=this;database.get_count(database.TABLES.BEATMAPS,function(count){self.beatmap_count=count;self.show_selection()});database.get_count(database.TABLES.REPLAYS,function(count){self.replay_count=count;self.show_selection()});event_handler.on(event_handler.EVENTS.BEATMAP_LOADED,this.on_load_file.bind(this))},cacheDom:function cacheDom(){if(!this.cached_dom){this.beatmap_selection_template=document.getElementById("beatmap_select_template").innerHTML;this.replay_selection_template=document.getElementById("replay_select_template").innerHTML;this.$beatmap_section_html=$("#song_selection_area");this.$replay_section_html=$("#replay_select_area");this.mapped_by=document.getElementById("mapped_by");this.map_length_and_objects=document.getElementById("map_length_and_objects");this.map_object_type_counts=document.getElementById("map_object_type_counts");this.map_difficulty=document.getElementById("map_difficulty");this.map_name=document.getElementById("map_name");this.$footer=$("#footer");this.$beatmap_search_field=$("#filter_maps_search");this.$replay_search_field=$("#filter_players_search");this.$title_and_search=$("#title_and_search");this.$details_replay_search=$("#details_replay_search");this.$asset_server_url=$("#asset_server_url");this.$song_server_url=$("#song_server_url");this.$save_asset_servers_btn=$("#save_asset_servers_btn");this.$master_volume_slider=$("#master_volume");this.$music_volume_slider=$("#music_volume");this.$sound_volume_slider=$("#sound_volume");this.$background_dim_slider=$("#background_dim");this.$skin_select=$("#skin_select");this.cached_dom=true;this.$deleteBeatmapModel=$("#delete_beatmap_modal");this.$deleteButton=this.$deleteBeatmapModel.find("#deleteMapButton");this.$deleteOtherDifficultiesCheckBox=this.$deleteBeatmapModel.find("#delete_other_difficulties");this.$deleteAssetsCheckBox=this.$deleteBeatmapModel.find("#delete_assets")}},bind_events:function bind_events(){if(!this.events_bound){$("#open_config_button_other").on("click",function(){osu.ui.interface.osugame.toggle_settings()});var self=this;this.$save_asset_servers_btn.on("click",function(){osu.settings.SETTINGS.asset_server=self.$asset_server_url.val();osu.settings.SETTINGS.song_url=self.$song_server_url.val()});this.$skin_select.on("change",function(){osu.settings.SETTINGS.selected_skin=self.$skin_select.val();osu.skins.init()});this.$beatmap_search_field.on("input",function(e){var searchParam=e.currentTarget.value;if(self.beatmapSearch&&searchParam!=""){self.$beatmap_section_html.find(".beatmap_preview:not([class*='hidden'])").addClass("hidden");self.beatmapSearch.search(searchParam,function(result){for(var i=0;i<result.length;i++){self.$beatmap_section_html.find("#"+result[i].md5sum).removeClass("hidden")}})}else{self.$beatmap_section_html.find(".beatmap_preview").removeClass("hidden");self.$currentSelectionHtml[0].scrollIntoViewIfNeeded()}});this.$replay_search_field.on("input",function(e){var searchParam=e.currentTarget.value;if(self.replaySearch&&searchParam!=""){self.$replay_section_html.find(".replay_preview:not([class*='hidden'])").addClass("hidden");self.replaySearch.search(searchParam,function(result){for(var i=0;i<result.length;i++){self.$replay_section_html.find("#"+result[i].rMd5Hash).removeClass("hidden")}})}else{self.$replay_section_html.find(".replay_preview").removeClass("hidden")}});this.$master_volume_slider.on("input",function(e){osu.settings.SETTINGS.master_volume=e.currentTarget.value/100;osu.audio.sound.play_sound(osu.audio.sound.MENUCLICK)});this.$music_volume_slider.on("input",function(e){osu.settings.SETTINGS.music_volume=e.currentTarget.value/100;osu.audio.sound.play_sound(osu.audio.sound.MENUCLICK)});this.$sound_volume_slider.on("input",function(e){osu.settings.SETTINGS.sound_effects_volume=e.currentTarget.value/100;osu.audio.sound.play_sound(osu.audio.sound.MENUCLICK)});this.$background_dim_slider.on("input",function(e){osu.settings.SETTINGS.background_dim=e.currentTarget.value/100;osu.audio.sound.play_sound(osu.audio.sound.MENUCLICK)});this.$beatmap_section_html.on("click",".beatmap_preview",function(event){osu.audio.sound.play_sound(osu.audio.sound.MENUCLICK);var clickedObject=$(this);var md5sum=clickedObject.attr("id");self.highlight_beatmap(clickedObject);self.select_beatmap(md5sum,false)});this.$beatmap_section_html.on("contextmenu",".beatmap_preview",function(e){e.preventDefault();self.deletion_id=$(this).attr("id");self.$deleteBeatmapModel.modal("show")});this.$deleteButton.on("click",self.delete_map.bind(self));$(this.$replay_section_html).on("click",".replay_preview",function(event){osu.audio.sound.play_sound(osu.audio.sound.MENUHIT);var id=$(this).attr("id");for(var i=0;i<self.replays.length;i++){if(self.replays[i].rMd5Hash==id){replay=self.replays[i];break}}loadBeatMap()});document.onkeyup=function(e){e=e||window.event;if(e.keyCode==27){if(self.loaded&&!self.displaying_main_screen){event_handler.emit(event_handler.EVENTS.STOP_REPLAY);if(!osu.ui.interface.osugame.has_started){self.show_main_screen()}}}}}this.events_bound=true},_delete_other_difficulties:function _delete_other_difficulties(id){var delete_array=[];var self=this;var parentMap=false;for(var i=0;i<this.beatmaps.length;i++){var beatmap=this.beatmaps[i];if(beatmap.md5sum==id){parentMap=beatmap;break}}if(parentMap){var beatmapSet=parentMap.beatmapsetid;for(i=0;i<this.beatmaps.length;i++){beatmap=this.beatmaps[i];if(beatmap.beatmapsetid==beatmapSet){delete_array.push(beatmap.md5sum)}}}for(i=0;i<delete_array.length;i++){self.$beatmap_section_html.find("#"+delete_array[i]).hide();database.delete_data(database.TABLES.BEATMAPS,delete_array[i])}},delete_map:function delete_map(id,other_difficulties,include_assets){var self=this;if((typeof id==="undefined"?"undefined":_typeof(id))=="object"){id=this.deletion_id;other_difficulties=this.$deleteOtherDifficultiesCheckBox.is(":checked");include_assets=this.$deleteAssetsCheckBox.is(":checked")}self.$beatmap_section_html.find("#"+id).hide();if(include_assets){database.get_data(database.TABLES.BEATMAPS,id,function(result){if(other_difficulties){self._delete_other_difficulties(id)}var beatmap=result.data;for(var i=0;i<beatmap.files.length;i++){database.delete_data(database.TABLES.ASSETS,beatmap.files[i].md5sum)}database.delete_data(database.TABLES.BEATMAPS,id)})}if(other_difficulties&&!include_assets){this._delete_other_difficulties(id)}if(!other_difficulties&&!include_assets){database.delete_data(database.TABLES.BEATMAPS,id)}},highlight_beatmap:function highlight_beatmap($beatmapHtml){this.$currentSelectionHtml=$beatmapHtml;this.$beatmap_section_html.find(".song_preview_row").removeClass("song_preview_unselected").removeClass("song_preview_mouseover").removeClass("song_preview_selected").addClass("song_preview_unselected");this.$beatmap_section_html.find(".beatmap_preview").removeClass("col-xs-9").removeClass("col-xs-8").removeClass("col-xs-7").removeClass("col-xs-offset-5").removeClass("col-xs-offset-4").removeClass("col-xs-offset-3").addClass("col-xs-offset-5").addClass("col-xs-7");$beatmapHtml.removeClass("col-xs-9").removeClass("col-xs-8").removeClass("col-xs-7").removeClass("col-xs-offset-5").removeClass("col-xs-offset-4").removeClass("col-xs-offset-3").addClass("col-xs-offset-3").addClass("col-xs-9");$beatmapHtml.find(".song_preview_row").removeClass("song_preview_unselected").addClass("song_preview_selected");$beatmapHtml[0].scrollIntoViewIfNeeded()},select_beatmap:function select_beatmap(md5sum,highlight_map){this.$replay_section_html.html("");var beatmap=null;for(var i=0;i<this.beatmaps.length;i++){if(this.beatmaps[i].md5sum==md5sum){beatmap=this.beatmaps[i];break}}this.map_name.innerHTML=Mustache.render("{{source}} "+"({{#artistunicode}}{{artistunicode}}{{/artistunicode}}{{^artistunicode}}{{artist}}{{/artistunicode}}) - "+"{{#titleunicode}}{{titleunicode}}{{/titleunicode}}{{^titleunicode}}{{title}}{{/titleunicode}}  [{{version}}]",beatmap);this.mapped_by.innerHTML="Mapped by "+beatmap.creator;this.map_length_and_objects.innerHTML="Length: "+beatmap.song_length+" BPM: "+(beatmap.maxBPM?beatmap.maxBPM+" - ":"")+beatmap.minBPM+" Objects: "+beatmap.objects;this.map_object_type_counts.innerHTML="Circles: "+beatmap.circles+" Sliders: "+beatmap.sliders+" Spinners "+beatmap.spinners;this.map_difficulty.innerHTML="CS: "+beatmap.circleSize+" AR: "+beatmap.approachRate+" OD: "+beatmap.overallDifficulty+" HP: "+beatmap.HPDrain+" Stars: "+beatmap.stars;beatmap.play_song();beatmap.load_background();var self=this;database.get_data_from_index(database.TABLES.REPLAYS,database.INDEXES.REPLAYS.BEATMAP_ID,beatmap.md5sum,function(replays){self.replays=replays;replays.sort(function(a,b){if(a.tScore>b.tScore)return-1;if(a.tScore<b.tScore)return 1;var aDate=new Date(a.time_played);var bDate=new Date(b.time_played);if(aDate>bDate){return-1}if(aDate<bDate){return 1}return 0});for(i=0;i<self.replays.length;i++){self.replays[i].grade_img=osu.skins.resources[osu.score.GRADES[self.replays[i].grade].small_icn].url}self.replaySearch=new Bloodhound({datumTokenizer:function datumTokenizer(datum){return Bloodhound.tokenizers.whitespace(datum.playerName)},queryTokenizer:Bloodhound.tokenizers.whitespace,local:self.replays});self.render_replay(self.replays)});this.current_selection=beatmap;if(highlight_map){this.highlight_beatmap($("#"+md5sum))}},render_replay:function render_replay(replays){var content=Mustache.render(this.replay_selection_template,{replays:replays});this.$replay_section_html.append(content)},show_selection:function show_selection(){if(this.beatmap_count>0&&this.replay_count>0){var self=this;database.get_all_keys(database.TABLES.BEATMAPS,function(keys){self.key_count=keys.length;for(var i=0;i<keys.length;i++){self.beatmap_keys.push(keys[i]);var beatmap=new osu.beatmaps.BeatmapPreview(keys[i],function(){self.processed_count++;self.songs_processed()});self.beatmaps.push(beatmap)}})}if(this.beatmap_count==0||this.replay_count==0){document.getElementById("loading").className="hidden";this.show_main_screen()}},songs_processed:function songs_processed(){if(this.key_count==this.processed_count){this.beatmaps.sort(function(a,b){if(a.title<b.title)return-1;if(a.title>b.title)return 1;if(a.stars<b.stars){return-1}if(a.stars>b.stars){return 1}return 0});for(var i=0;i<this.beatmaps.length;i++){this.render_song(this.beatmaps[i])}this.beatmapSearch=new Bloodhound({datumTokenizer:function datumTokenizer(datum){var matchon=datum.title+" "+datum.artist+" "+datum.tags;return Bloodhound.tokenizers.whitespace(matchon)},queryTokenizer:Bloodhound.tokenizers.whitespace,local:this.beatmaps});this.show_main_screen()}},show_main_screen:function show_main_screen(){osu.ui.interface.replaycontroller.hideBar();document.getElementById("loading").className="hidden";document.getElementById("no_beatmaps_replays").className="hidden";document.getElementById("container").className="";document.getElementById("main_menu").className="";document.getElementById("render_zone").className="hidden";document.getElementById("replay_url_area").className="hidden";document.getElementById("open_config_button_other").className="hidden";this.$asset_server_url.val(osu.settings.SETTINGS.asset_server);this.$song_server_url.val(osu.settings.SETTINGS.song_url);if(this.$footer.css("display")=="none"){this.$footer.toggle("slide",{direction:"down"})}if(this.$replay_section_html.css("display")=="none"){this.$replay_section_html.toggle("slide",{direction:"left"})}if(this.$title_and_search.css("display")=="none"){this.$title_and_search.toggle("slide",{direction:"up"})}if(this.$details_replay_search.css("display")=="none"){this.$details_replay_search.toggle("slide",{direction:"up"})}if(this.$beatmap_section_html.css("display")=="none"){this.$beatmap_section_html.toggle("slide",{direction:"right"})}this.$skin_select.empty();this.$skin_select.append("<option value=\"0\">Default</option>");for(var i=0;i<osu.skins.skins.length;i++){this.$skin_select.append("<option value=\""+osu.skins.skins[i].md5sum+"\">"+osu.skins.skins[i].name+"</option>")}this.$skin_select.val(osu.settings.SETTINGS.selected_skin);this.$footer.find("#skin_settings").attr("style","");this.$footer.find("#skin_select_field").attr("style","");this.loaded=true;this.displaying_main_screen=true;if(!this.current_selection){this.select_beatmap(this.beatmaps[Math.floor(Math.random()*this.beatmaps.length)].md5sum,true)}else{this.current_selection.load_background()}this.$beatmap_search_field.focus()},hide_main_screen:function hide_main_screen(){console.log(this.$footer.css("display"));if(this.$footer.css("display")!="none"){this.$footer.toggle("slide",{direction:"down"})}if(this.$beatmap_section_html.css("display")!="none"){this.$beatmap_section_html.toggle("slide",{direction:"right"})}if(this.$replay_section_html.css("display")!="none"){this.$replay_section_html.toggle("slide",{direction:"left"})}if(this.$title_and_search.css("display")!="none"){this.$title_and_search.toggle("slide",{direction:"up"})}if(this.$details_replay_search.css("display")!="none"){this.$details_replay_search.toggle("slide",{direction:"up"})}this.displaying_main_screen=false},set_background:function set_background(background_data){document.body.style.background="url("+background_data+") no-repeat center fixed";document.body.style.backgroundSize="100% 100%"},remove_background:function remove_background(){document.body.style.background=""},display_new_song:function display_new_song(md5sum){if(this.displaying_main_screen){}},load_song:function load_song(md5sum){var self=this;var curr_length=this.beatmaps.length;var beatmap=new osu.beatmaps.BeatmapPreview(md5sum,function(){self.render_song(self.beatmaps[curr_length+1]);self.display_new_song(md5sum)});this.beatmaps.push(beatmap);this.beatmap_keys.push(md5sum)},render_song:function render_song(beatmap){var content=Mustache.render(this.beatmap_selection_template,{beatmaps:beatmap});this.$beatmap_section_html.append(content)},on_load_file:function on_load_file(data){if(!this.loaded){this.init()}else{for(var i=0;i<data.md5sums.length;i++){if(this.beatmap_keys.indexOf(data.md5sums[i])==-1){this.load_song(data.md5sums[i])}};}}};var osu=osu||{};osu.ui=osu.ui||{};osu.ui.interface=osu.ui.interface||{};osu.ui.interface.osugame={master_container:new PIXI.Container,offSetDetails:null,replay_data:[],key_1_count:0,key_2_count:0,key_3_count:0,key_4_count:0,key_1_pressed:false,key_2_pressed:false,key_3_pressed:false,key_4_pressed:false,beatmap:{},expected_replay_movment_time:null,gone_over:0,has_started:false,audioLeadIn:0,countdown_started:false,curr_replay_frame:0,mods:[],oldest_object_position:0,oldestReplayFrame:0,replay_intro_time:-1,end_skip_frame:-1,skip_frames:[],flash_count:0,warning_arrow_times:[],break_times:[],replay_played_by_text:"",hit_objects:[],events_bound:false,curMapTime:0,replayDiff:0,delayEnd:0,finished:false,keyPresses:[],currentKeyPress:0,lasthit_id:1000,paused:false,paused_time:0,currentMap:function currentMap(){return this.beatmap},currentReplay:function currentReplay(){return this.replay_data},currentHitObjects:function currentHitObjects(){return this.hit_objects},calculateLetterBox:function calculateLetterBox(){var x=osu.ui.renderer.renderWidth;var y=osu.ui.renderer.renderHeight;var fixed_ratio_y=3/4*x;var fixed_ratio_x=4/3*y;var details={width:x,height:y,x_offset:0,y_offset:0};if(fixed_ratio_y>y){details.width=fixed_ratio_x}else{details.height=fixed_ratio_y}details.x_offset=(x-details.width)/2||0;details.y_offset=(y-details.height)/2||0;return details},getRenderWidth:function getRenderWidth(){return osu.ui.renderer.renderWidth},getRenderHeight:function getRenderHeight(){return osu.ui.renderer.renderHeight},create_dimmer:function create_dimmer(){this.background_dimmer=this.background_dimmer||new PIXI.Container;this.background_dimmer.removeChildren();var dimmer=new PIXI.Graphics;dimmer.beginFill(0,osu.settings.SETTINGS.background_dim);dimmer.drawRect(0,0,this.getRenderWidth(),this.getRenderHeight());this.background_dimmer.addChild(dimmer)},create_background:function create_background(){this.beatmap.background=this.beatmap.background||"";var background=PIXI.Texture.fromImage(this.beatmap.background);var background_sprite=new PIXI.Sprite(background);background_sprite.width=this.getRenderWidth();background_sprite.height=this.getRenderHeight();this.master_container.addChild(background_sprite);this.create_dimmer();this.master_container.addChild(this.background_dimmer)},create_pause_screen_container:function create_pause_screen_container(){this.pauseScreenContainer=new PIXI.Container;this.pauseScreenContainer.visible=false;var overlayTexture=osu.skins.resources.pause_overlay.texture;this.overlaySprite=new PIXI.Sprite(overlayTexture);this.overlaySprite.width=this.getRenderWidth();this.overlaySprite.height=this.getRenderHeight();this.pauseScreenContainer.addChild(this.overlaySprite);var resumeButtonTexture=osu.skins.resources.pause_continue.texture;this.resumeButtonSprite=new PIXI.Sprite(resumeButtonTexture);this.resumeButtonSprite.position.x=this.getRenderWidth()/2;this.resumeButtonSprite.position.y=this.getRenderHeight()*0.26;this.resumeButtonSprite.anchor.set(0.5);this.resumeButtonSprite.interactive=true;this.resumeButtonSprite.on("mouseup",this.toggle_pause.bind(this));this.resumeButtonSprite.on("touchend",this.toggle_pause.bind(this));this.pauseScreenContainer.addChild(this.resumeButtonSprite);var backButtonTexture=osu.skins.resources.pause_back.texture;this.backButtonSprite=new PIXI.Sprite(backButtonTexture);this.backButtonSprite.position.x=this.getRenderWidth()/2;this.backButtonSprite.position.y=this.getRenderHeight()*0.74;this.backButtonSprite.anchor.set(0.5);this.backButtonSprite.interactive=true;this.backButtonSprite.on("mouseup",this.end_replay.bind(this));this.backButtonSprite.on("touchend",this.end_replay.bind(this));this.pauseScreenContainer.addChild(this.backButtonSprite);this.master_container.addChild(this.pauseScreenContainer)},tint_untint_key:function tint_untint_key(key,do_tint){if(do_tint){key.scale={x:1.1,y:1.1};key.tint=16776960}else{key.scale={x:1,y:1};key.tint=16777215}},create_key_press:function create_key_press(){this.keypress_area=new PIXI.Container;var keypress_texture=osu.skins.resources.inputoverlay_key.texture;this.keypress_1=new PIXI.Sprite(keypress_texture);this.keypress_2=new PIXI.Sprite(keypress_texture);this.keypress_3=new PIXI.Sprite(keypress_texture);this.keypress_4=new PIXI.Sprite(keypress_texture);var style={font:"14px Arial"};this.keypress_1_Text=new PIXI.Text(this.key_1_count>0&&this.key_1_count.toString()||"K1",style);this.keypress_2_Text=new PIXI.Text(this.key_2_count>0&&this.key_2_count.toString()||"K2",style);this.keypress_3_Text=new PIXI.Text(this.key_3_count>0&&this.key_3_count.toString()||"M1",style);this.keypress_4_Text=new PIXI.Text(this.key_4_count>0&&this.key_4_count.toString()||"M2",style);this.keypress_1.tint=16776960;this.keypress_1.x=this.getRenderWidth()-40;this.keypress_1.y=this.getRenderHeight()/2-55;this.keypress_1.anchor.set(0.5);this.keypress_1_Text.anchor.set(0.5);this.keypress_1_Text.x=this.keypress_1.x;this.keypress_1_Text.y=this.keypress_1.y;this.keypress_2.x=this.getRenderWidth()-40;this.keypress_2.y=this.getRenderHeight()/2;this.keypress_2.anchor.set(0.5);this.keypress_2_Text.anchor.set(0.5);this.keypress_2_Text.x=this.keypress_2.x;this.keypress_2_Text.y=this.keypress_2.y;this.keypress_3.x=this.getRenderWidth()-40;this.keypress_3.y=this.getRenderHeight()/2+55;this.keypress_3.anchor.set(0.5);this.keypress_3_Text.anchor.set(0.5);this.keypress_3_Text.x=this.keypress_3.x;this.keypress_3_Text.y=this.keypress_3.y;this.keypress_4.x=this.getRenderWidth()-40;this.keypress_4.y=this.getRenderHeight()/2+110;this.keypress_4.anchor.set(0.5);this.keypress_4_Text.anchor.set(0.5);this.keypress_4_Text.x=this.keypress_4.x;this.keypress_4_Text.y=this.keypress_4.y;this.keypress_area.addChild(this.keypress_1);this.keypress_area.addChild(this.keypress_2);this.keypress_area.addChild(this.keypress_3);this.keypress_area.addChild(this.keypress_4);this.keypress_area.addChild(this.keypress_1_Text);this.keypress_area.addChild(this.keypress_2_Text);this.keypress_area.addChild(this.keypress_3_Text);this.keypress_area.addChild(this.keypress_4_Text);this.master_container.addChild(this.keypress_area)},create_cursor:function create_cursor(){this.cursor=new PIXI.Container;var cursor_texture=osu.skins.resources.cursor.texture;var cursor_middle_texture=osu.skins.resources.cursormiddle.texture;var cursor_sprite=new PIXI.Sprite(cursor_texture);var cursor_middle_sprite=new PIXI.Sprite(cursor_middle_texture);cursor_sprite.anchor.set(0.5);cursor_middle_sprite.anchor.set(0.5);this.cursor.addChild(cursor_sprite);this.cursor.addChild(cursor_middle_sprite);this.cursor.x=this.getRenderWidth()/2;this.cursor.y=this.getRenderHeight()/2;this.master_container.addChild(this.cursor)},create_skip_container:function create_skip_container(){this.skip_container=new PIXI.Container;var skipFrames=[];if(osu.skins.resources.play_skip_0){for(var i=0;i<99;i++){if(osu.skins.resources["play_skip_"+i]){skipFrames.push(osu.skins.resources["play_skip_"+i].texture)}else{break}}}else{skipFrames.push(osu.skins.resources.play_skip.texture)}var skipAnimation=new PIXI.extras.MovieClip(skipFrames);skipAnimation.anchor.set(0.5);skipAnimation.x=this.calculate_x(512);skipAnimation.y=this.calculate_y(384);skipAnimation.interactive=true;skipAnimation.on("mouseup",this.skip_intro.bind(this));skipAnimation.animationSpeed=0.1;skipAnimation.play();this.skip_container.visible=false;this.skip_container.addChild(skipAnimation);this.master_container.addChild(this.skip_container)},create_play_warn_arrows_container:function create_play_warn_arrows_container(){this.arrow_container=new PIXI.Container;var arrow_texture=osu.skins.resources.play_warningarrow.texture;var skip_arrow_sprite_1=new PIXI.Sprite(arrow_texture);var skip_arrow_sprite_2=new PIXI.Sprite(arrow_texture);var skip_arrow_sprite_3=new PIXI.Sprite(arrow_texture);var skip_arrow_sprite_4=new PIXI.Sprite(arrow_texture);skip_arrow_sprite_1.anchor.set(0.5);skip_arrow_sprite_2.anchor.set(0.5);skip_arrow_sprite_3.anchor.set(0.5);skip_arrow_sprite_4.anchor.set(0.5);skip_arrow_sprite_1.x=this.calculate_x(25);skip_arrow_sprite_1.y=this.calculate_y(19);skip_arrow_sprite_2.scale.x=-1;skip_arrow_sprite_2.x=this.calculate_x(487);skip_arrow_sprite_2.y=this.calculate_y(19);skip_arrow_sprite_3.x=this.calculate_x(25);skip_arrow_sprite_3.y=this.calculate_y(365);skip_arrow_sprite_4.scale.x=-1;skip_arrow_sprite_4.x=this.calculate_x(487);skip_arrow_sprite_4.y=this.calculate_y(365);this.arrow_container.addChild(skip_arrow_sprite_1);this.arrow_container.addChild(skip_arrow_sprite_2);this.arrow_container.addChild(skip_arrow_sprite_3);this.arrow_container.addChild(skip_arrow_sprite_4);this.arrow_container.visible=false;this.master_container.addChild(this.arrow_container)},create_success_container:function create_success_container(){this.success_container=new PIXI.Container;var success_texture=osu.skins.resources.section_pass.texture;var success_sprite=new PIXI.Sprite(success_texture);success_sprite.anchor.set(0.5);success_sprite.x=this.getRenderWidth()/2;success_sprite.y=this.getRenderHeight()/2;this.success_container.visible=false;this.success_container.addChild(success_sprite);this.master_container.addChild(this.success_container)},create_fail_container:function create_fail_container(){this.fail_container=new PIXI.Container;var fail_texture=osu.skins.resources.section_fail.texture;var fail_sprite=new PIXI.Sprite(fail_texture);fail_sprite.anchor.set(0.5);fail_sprite.x=this.getRenderWidth()/2;fail_sprite.y=this.getRenderHeight()/2;this.fail_container.visible=false;this.fail_container.addChild(fail_sprite);this.master_container.addChild(this.fail_container)},create_replay_by_text:function create_replay_by_text(){this.replay_text=new PIXI.Text(this.replay_played_by_text,{font:"30px Arial",fill:"#FFFFFF"});this.replay_text.y=this.getRenderHeight()/8;this.replay_text.x=this.getRenderWidth()/2;this.master_container.addChild(this.replay_text)},create_mod_container:function create_mod_container(){for(var i=0;i<this.mods.length;i++){if(this.mods[i].icon!=""){var modpng=osu.skins.resources[this.mods[i].icon].texture;var modSprite=new PIXI.Sprite(modpng);modSprite.position.y=this.getRenderHeight()/5;modSprite.position.x=this.getRenderWidth()*0.95-i*50;modSprite.anchor.set(0.5);this.master_container.addChild(modSprite)}}},create_settings_icon_container:function create_settings_icon_container(){this.settingIconContainer=new PIXI.Container;var settingsTexture=new PIXI.Texture.fromImage("data/settings.png");var settingsSprite=new PIXI.Sprite(settingsTexture);settingsSprite.anchor.set(1);settingsSprite.x=this.getRenderWidth();settingsSprite.y=this.getRenderHeight();settingsSprite.alpha=0.9;settingsSprite.interactive=true;settingsSprite.on("mouseup",this.toggle_settings.bind(this));this.settingIconContainer.addChild(settingsSprite);this.master_container.addChild(this.settingIconContainer)},create_timer_container:function create_timer_container(){this.timerX=this.getRenderWidth()-this.getRenderWidth()*0.11;this.timerY=this.getRenderHeight()*0.1;var timerContainer=new PIXI.Container;var baseCircle=new PIXI.Graphics;baseCircle.lineStyle(4,16777215);baseCircle.beginFill(0,0);baseCircle.drawCircle(0,0,25);baseCircle.beginFill(16777215,2);baseCircle.drawCircle(0,0,1);var baseCircleTexture=baseCircle.generateTexture();var baseCircleSprite=new PIXI.Sprite(baseCircleTexture);baseCircleSprite.position.x=this.timerX;baseCircleSprite.position.y=this.timerY;baseCircleSprite.anchor.set(0.5);this.timerMask=new PIXI.Graphics;this.timerPie=new PIXI.Graphics;this.timerPie.mask=this.timerMask;this.timerPie.beginFill(11842738,0.8);this.timerPie.drawCircle(this.timerX,this.timerY,25);this.timerPie.endFill();timerContainer.addChild(this.timerPie);timerContainer.addChild(baseCircleSprite);this.master_container.addChild(timerContainer)},update_timer_percentage:function update_timer_percentage(percentage,colour){var createPoint=function createPoint(x,y){return{x:x,y:y}};var rotateXY=function rotateXY(x,y,angle){var rad=Math.PI*angle/180;var cosVal=Math.cos(rad);var sinVal=Math.sin(rad);return createPoint(cosVal*x-sinVal*y,sinVal*x+cosVal*y)};var computeMaskPolygon=function computeMaskPolygon(x,y,radius,angle){while(angle<0){angle+=360}angle%=360;var delta=rotateXY(0,-2*radius,angle);var pts=[createPoint(x,y-2*radius),createPoint(x,y),createPoint(x+delta.x,y+delta.y)];if(angle>270)pts.push(createPoint(x-2*radius,y));if(angle>180)pts.push(createPoint(x,y+2*radius));if(angle>90)pts.push(createPoint(x+2*radius,y));return pts};this.timerPie.clear();this.timerPie.beginFill(colour,0.8);this.timerPie.drawCircle(this.timerX,this.timerY,25);this.timerPie.endFill();this.timerMask.clear();var angle=percentage*360;if(angle>=360)angle=359.9;var pts=computeMaskPolygon(this.timerX,this.timerY,25,angle);this.timerMask.beginFill(16777215);this.timerMask.moveTo(pts[0].x,pts[0].y);for(var i=1;i<pts.length;++i){this.timerMask.lineTo(pts[i].x,pts[i].y)}this.timerMask.lineTo(pts[0].x,pts[0].y);this.timerMask.endFill()},createSmokeContainer:function createSmokeContainer(){this.smokeContainer=new PIXI.Container;this.master_container.addChild(this.smokeContainer)},createScoreContainer:function createScoreContainer(){var style={font:"bold 80px Arial",fill:"#FFFFFF",align:"center",stroke:"#000000",strokeThickness:6};this.scoreText=new PIXI.Text("0",style);this.scoreText.anchor.set(1,0);this.scoreText.y=0;this.scoreText.x=this.getRenderWidth();this.comboText=new PIXI.Text("0X",style);this.comboText.anchor.set(0,1);this.comboText.y=this.getRenderHeight()*0.95;var style={font:"bold 50px Arial",fill:"#FFFFFF",align:"center",stroke:"#000000",strokeThickness:6};this.accuracyText=new PIXI.Text("0.00%",style);this.accuracyText.anchor.set(1,0.5);this.accuracyText.y=this.getRenderHeight()*0.1;this.accuracyText.x=this.getRenderWidth();var scoreContainer=new PIXI.Container;scoreContainer.addChild(this.scoreText);scoreContainer.addChild(this.comboText);scoreContainer.addChild(this.accuracyText);this.master_container.addChild(scoreContainer)},create_master_container:function create_master_container(){this.master_container.removeChildren();this.hit_object_container=new PIXI.Container;this.create_background();this.create_key_press();this.create_mod_container();this.create_replay_by_text();this.create_timer_container();this.createSmokeContainer();this.createScoreContainer();this.master_container.addChild(this.hit_object_container);this.create_skip_container();this.create_success_container();this.create_fail_container();this.create_play_warn_arrows_container();this.create_cursor();this.create_pause_screen_container()},flash_warning_arrows:function flash_warning_arrows(){if(this.flash_count<15){var self=this;setTimeout(function(){self.arrow_container.visible=!self.arrow_container.visible;self.flash_count++;self.flash_warning_arrows()},150)}else{this.arrow_container.visible=false;this.flash_count=0}},show_success:function show_success(){this.success_container.visible=true;osu.audio.sound.play_sound(osu.audio.sound.SECTIONPASS);var self=this;setTimeout(function(){self.success_container.visible=false},4000)},show_failure:function show_failure(){this.fail_container.visible=true;var self=this;setTimeout(function(){self.fail_container.visible=false},4000)},end_replay:function end_replay(){this.finished=true;this.has_started=false;osu.ui.interface.mainscreen.show_main_screen()},bind_events:function bind_events(){if(!this.events_bound){event_handler.on(event_handler.EVENTS.SETTINGS_CHANGED,this.create_dimmer.bind(this));event_handler.on(event_handler.EVENTS.STOP_REPLAY,this.toggle_pause.bind(this));this.events_bound=true}},calculate_x:function calculate_x(x){x=parseInt(x);var result=this.offSetDetails.width/640*(x+64)+this.offSetDetails.x_offset;return result},calculate_y:function calculate_y(y){y=parseInt(y);return this.offSetDetails.height/480*(y+48)+this.offSetDetails.y_offset},calculate_original_x:function calculate_original_x(x){x=parseInt(x);return(x+64)/(this.offSetDetails.width/640)},calculate_original_y:function calculate_original_y(y){y=parseInt(y);return(y+48)/(this.getRenderHeight()/480)},toggle_settings:function toggle_settings(){this.$footer.find("#skin_settings").css("display","none");this.$footer.find("#skin_select_field").css("display","none");this.$footer.css("background","rgba(0,0,0,0.6");this.$footer.slideToggle()},hide_settings:function hide_settings(){if(this.$footer.css("display")=="none"){this.$footer.slideToggle()}},initGame:function initGame(){osu.ui.interface.replaycontroller.bindEvents();this.paused=false;this.paused_time=0;event_handler.off(event_handler.EVENTS.RENDER,"replay_text");this.currentKeyPress=0;this.key_1_count=0;this.key_2_count=0;this.key_3_count=0;this.key_4_count=0;this.$footer=osu.ui.interface.mainscreen.$footer||$("#footer");this.$footer.attr("style","");this.$footer.css("display","none");osu.ui.renderer.start();this.offSetDetails=this.calculateLetterBox();this.create_master_container();osu.ui.renderer.clearStage();osu.ui.renderer.addChild(this.master_container);this.bind_events();this.curMapTime=0;this.has_started=false;this.countdown_started=false;this.curr_replay_frame=0;this.expected_replay_movment_time=null;this.oldest_object_position=0;this.warning_arrow_times=[];this.is_hidden=false;this.is_hardrock=false;this.is_easy=false;this.oldestReplayFrame=0;this.is_halftime=false;this.is_doubletime=false;this.replayDiff=0;this.break_times=[];this.warning_arrow_times=[];this.delayEnd=0;this.finished=false;var modMulti=1;for(var i=0;i<this.mods.length;i++){var mod=this.mods[i].code;modMulti*=this.mods[i].multi;if(mod=="HD")this.is_hidden=true;if(mod=="HR")this.is_hardrock=true;if(mod=="EZ")this.is_easy=true;if(mod=="DT"||mod=="NT")this.is_doubletime=true;if(mod=="HT")this.is_halftime=true}for(i=0;i<this.beatmap.map_data.events.length;i++){if(this.beatmap.map_data.events[i][0]=="2"){var startTime=parseInt(this.beatmap.map_data.events[i][1]);var endTime=parseInt(this.beatmap.map_data.events[i][2])-2300;if(this.is_doubletime){startTime*=osu.helpers.constants.DOUBLE_TIME_MULTI;endTime*=osu.helpers.constants.DOUBLE_TIME_MULTI}this.break_times.push({t:startTime,played:false});this.warning_arrow_times.push({t:endTime,played:false})}}var comboNum=0;var comboColour=0;var approachRate=parseInt(this.beatmap.map_data.difficulty.ApproachRate);var overallDifficulty=this.beatmap.map_data.difficulty.OverallDifficulty;var difficultyCircleSize=parseInt(this.beatmap.map_data.difficulty.CircleSize);var hpDrain=parseInt(this.beatmap.map_data.difficulty.HPDrainRate);this.sliderMultiplier=parseFloat(this.beatmap.map_data.difficulty.SliderMultiplier||1);this.sliderTickRate=parseFloat(this.beatmap.map_data.difficulty.SliderTickRate||1);this.performance=new osu.game.Perforamnce(overallDifficulty+difficultyCircleSize+hpDrain,modMulti,hpDrain);if(this.is_hardrock){approachRate*=1.4;overallDifficulty*=1.4}if(this.is_easy){approachRate*=0.5;overallDifficulty*=0.5}approachRate=Math.min(approachRate,10);overallDifficulty=Math.min(overallDifficulty,10);if(this.is_hardrock&&difficultyCircleSize<7)difficultyCircleSize+=1;if(this.is_easy&&difficultyCircleSize>1)difficultyCircleSize-=1;var unScaledDiameter=108.848-difficultyCircleSize*8.9646;var circleSize=this.offSetDetails.width/640*unScaledDiameter;this.approachTime=0;if(approachRate<5){this.approachTime=1800-approachRate*120}else{this.approachTime=1200-(approachRate-5)*150}if(this.is_doubletime)this.approachTime=this.approachTime-this.approachTime*0.33;if(!this.beatmap.been_rendered){this.keyPresses=[];this.hit_objects=[];for(i=0;i<this.beatmap.map_data.hit_objects.length;i++){var hitObject=new osu.objects.HitObject(this.beatmap.map_data.hit_objects[i],circleSize,this.approachTime,this);if(comboNum==0||hitObject.newCombo){comboNum=1;if(comboColour==osu.skins.COMBO_COLOURS.length-1){comboColour=0}else{comboColour++}}else{comboNum++}hitObject.colour=osu.skins.COMBO_COLOURS[comboColour];hitObject.combo=comboNum;hitObject.hitOffset={HIT_300:79.5-overallDifficulty*6,HIT_100:139.5-overallDifficulty*8,HIT_50:199.5-overallDifficulty*10,HIT_MISS:500-overallDifficulty*10};this.hit_objects.push(hitObject)}osu.objects.HitObjectParser.create_stacks(this.hit_objects,parseFloat(this.beatmap.map_data.general.StackLeniency)||0.7,unScaledDiameter,this.is_hardrock);this.keyPresses=osu.calculateReplay(this.hit_objects,this.replay_data,unScaledDiameter);osu.objects.HitObjectParser.initialiseHitObjects(this.hit_objects);osu.objects.HitObjectParser.calculate_follow_points(this.hit_objects,this);this.beatmap.been_rendered=true}else{for(var i=0;i<this.hit_objects.length;i++){this.hit_objects[i].reset()}}this.audioLeadIn=parseInt(this.beatmap.map_data.general.AudioLeadIn);if(this.is_doubletime)this.audioLeadIn=this.audioLeadIn*osu.helpers.constants.DOUBLE_TIME_MULTI;if(!replay.been_rendered){for(var i=0;i<this.replay_data.length;i++){this.replay_data[i].orig_x=this.replay_data[i].x;this.replay_data[i].orig_y=this.replay_data[i].y;this.replay_data[i].orig_t=this.replay_data[i].t;this.replay_data[i].x=this.calculate_x(this.replay_data[i].x);this.replay_data[i].y=this.calculate_y(this.replay_data[i].y);if(this.is_doubletime){this.replay_data[i].t*=osu.helpers.constants.DOUBLE_TIME_MULTI}}replay.been_rendered=true}this.skip_frames=[];var skipFrame=this.replay_data[1];this.skipTime=-1;if(skipFrame.t>0){if(this.replay_data[2].t>0){this.replayDiff=this.replay_data[2].t*-1}this.skipTime=skipFrame.t;this.warning_arrow_times.push({t:this.skipTime,played:false})}else{if(this.replay_data[2].t<0){this.replayDiff=this.replay_data[2].t*-1;if(this.audioLeadIn==0){this.audioLeadIn=this.replayDiff;if(this.is_doubletime)this.audioLeadIn*=osu.helpers.constants.DOUBLE_TIME_MULTI}}}osu.ui.interface.replaycontroller.set_duration(this.beatmap.map_data.time_length+2000);this.delayEnd=this.beatmap.map_data.time_length+2500;if(this.is_doubletime){osu.ui.interface.replaycontroller.set_duration(this.beatmap.map_data.time_length*osu.helpers.constants.DOUBLE_TIME_MULTI);this.delayEnd*=osu.helpers.constants.DOUBLE_TIME_MULTI}osu.ui.interface.replaycontroller.enable_progressbar();osu.ui.interface.replaycontroller.showPauseIcon();event_handler.on(event_handler.EVENTS.RENDER,this.move_replay_text.bind(this),"replay_text")},move_replay_text:function move_replay_text(){if(!this.paused){if(this.replay_text.x<-this.replay_text.width+5){this.replay_text.x=this.getRenderWidth()}this.replay_text.x-=2}},renderKeyPress:function renderKeyPress(){for(var i=this.currentKeyPress;i<this.keyPresses.length;i++){if(this.paused){break}var keyPress=this.keyPresses[i];if(keyPress.t<=this.curMapTime){var tint_1=keyPress.K1;var tint_2=keyPress.K2;var tint_3=keyPress.M1;var tint_4=keyPress.M2;this.tint_untint_key(this.keypress_1,tint_1);this.tint_untint_key(this.keypress_2,tint_2);this.tint_untint_key(this.keypress_3,tint_3);this.tint_untint_key(this.keypress_4,tint_4);this.currentKeyPress=i;if(keyPress.REPLAYHIT&&this.lasthit_id!=keyPress.ID){if(keyPress.K1){this.key_1_count++}if(keyPress.K2){this.key_2_count++}if(keyPress.M1){this.key_3_count++}if(keyPress.M2){this.key_4_count++}this.keypress_1_Text.text=this.key_1_count>0&&this.key_1_count.toString()||"K1";this.keypress_2_Text.text=this.key_2_count>0&&this.key_2_count.toString()||"K2";this.keypress_3_Text.text=this.key_3_count>0&&this.key_3_count.toString()||"M1";this.keypress_4_Text.text=this.key_4_count>0&&this.key_4_count.toString()||"M2";this.lasthit_id=keyPress.ID}if(keyPress.SMOKE){var pos=this.getCursorPos();keyPress.x=pos.x;keyPress.y=pos.y;if(i>0){var lastKey=this.keyPresses[i-1];if(lastKey.SMOKE){var xDiff=keyPress.x-lastKey.x;var yDiff=keyPress.y-lastKey.y;var distance=osu.helpers.math.distance(keyPress.x,keyPress.y,lastKey.x,lastKey.y);var numPoints=Math.round(distance/20);var steps=1/(numPoints+1);var nextStep=steps;for(var j=0;j<numPoints;j++){var posX=keyPress.x+xDiff*nextStep;var posY=keyPress.y+yDiff*nextStep;var smoke=osu.objects.Smoke(posX,posY);this.smokeContainer.addChild(smoke);nextStep+=steps}}}var smoke=osu.objects.Smoke(pos.x,pos.y);this.smokeContainer.addChild(smoke)}}else{break}}},render_object:function render_object(){var time=this.curMapTime;for(var x=0;x<this.warning_arrow_times.length;x++){if(time>this.warning_arrow_times[x].t+2000&&!this.warning_arrow_times[x].played){this.warning_arrow_times[x].played=true;this.flash_warning_arrows();break}}for(var x=0;x<this.break_times.length;x++){if(time>this.break_times[x].t+1000&&!this.break_times[x].played){this.break_times[x].played=true;this.show_success();break}}for(var i=this.oldest_object_position;i<this.hit_objects.length;i++){if(this.hit_objects[i].startTime-this.approachTime>time){break}if(!this.hit_objects[i].draw(time)){if(this.oldest_object_position+1==i){this.oldest_object_position=i}}}osu.ui.interface.replaycontroller.set_position(this.curMapTime);if(this.curMapTime-this.skipTime>0){this.update_timer_percentage(this.curMapTime/this.beatmap.map_data.time_length,osu.helpers.constants.TIMER_SONG_COLOUR)}if(this.oldest_object_position==this.hit_objects.length-1){if(this.curMapTime>=this.delayEnd){this.finished=true;event_handler.off(event_handler.EVENTS.RENDER,"replay_text");osu.ui.interface.scorescreen.renderScoreScreen()}}this.comboText.text=this.performance.combo+"X";this.accuracyText.text=this.performance.accuracy+"%";this.scoreText.text=this.performance.score},skip_intro:function skip_intro(){if(this.skipTime&&this.curMapTime<this.skipTime){osu.audio.sound.play_sound(osu.audio.sound.MENUHIT);osu.audio.music.set_position(this.skipTime/1000);this.curMapTime=this.skipTime;var elapsed_time=Date.now()-this.date_started;this.date_started-=this.skipTime-elapsed_time}},getCursorPos:function getCursorPos(){return{x:this.cursor.x,y:this.cursor.y}},render_replay_frame:function render_replay_frame(){var curTime=this.curMapTime;if(this.skipTime>0)curTime+=this.skipTime;for(var i=this.oldestReplayFrame;i<this.replay_data.length;i++){var t=this.replay_data[i].t-this.replayDiff;if(t<=0){var x=this.replay_data[i].x;var y=this.replay_data[i].y;if(x>0&&y>0){this.cursor.x=x;this.cursor.y=y;i++;this.oldestReplayFrame=i;break}}if(curTime>=t){var x=this.replay_data[i].x;var y=this.replay_data[i].y;if(x>0&&y>0){this.cursor.x=x;this.cursor.y=y;i++;this.oldestReplayFrame=i;break}}else{break}}},toggle_pause:function toggle_pause(){if(!this.paused){osu.ui.interface.replaycontroller.showPlayIcon();this.paused=true;this.pauseScreenContainer.visible=true;if(this.has_started){this.paused_time=Date.now();osu.audio.music.pause()}return}osu.ui.interface.replaycontroller.showPauseIcon();this.pauseScreenContainer.visible=false;this.paused=false;if(this.has_started){osu.audio.music.play()}},go_to:function go_to(t){this.smokeContainer.removeChildren(0);this.paused=true;osu.audio.music.pause();osu.audio.music.set_position(t/1000);for(var i=0;i<this.break_times.length;i++){this.break_times[i].played=t>this.break_times[i].t}for(i=0;i<this.warning_arrow_times.length;i++){this.warning_arrow_times[i].played=t>this.warning_arrow_times[i].t}this.performance.totalHits=0;this.performance.h300=0;this.performance.h100=0;this.performance.h50=0;this.performance.hMiss=0;this.performance.combo=0;this.performance.score=0;this.performance.accuracy=100;var addScore=function addScore(hitobject,performance){switch(hitobject.hitType){case"HIT_MISS":performance.addMiss();break;case"HIT_50":performance.add50();break;case"HIT_100":performance.add100();break;case"HIT_300":performance.add300();break;}};this.hit_object_container.removeChildren(0);this.oldest_object_position=0;for(i=0;i<this.hit_objects.length;i++){var hitobject=this.hit_objects[i];if(hitobject.is_circle){if(hitobject.hitTime<t){hitobject.destroy();addScore(hitobject,this.performance)}else{hitobject.reset()}}else{if(hitobject.endTime<t){hitobject.destroy();if(hitobject.is_slider){addScore(hitobject,this.performance)}}else{hitobject.reset()}}}for(i=0;i<this.replay_data.length;i++){var replayTime=this.replay_data[i].t-this.replayDiff-this.skipTime;if(replayTime>=t){if(i>0){this.oldestReplayFrame=i-1}else{this.oldestReplayFrame=0}break}}this.key_1_count=0;this.key_2_count=0;this.key_3_count=0;this.key_4_count=0;this.lasthit_id=-1;this.currentKeyPress=0;for(i=0;i<this.keyPresses.length;i++){var keyPress=this.keyPresses[i];if(keyPress.t<=t){this.currentKeyPress=i;if(keyPress.REPLAYHIT&&this.lasthit_id!=keyPress.ID){if(keyPress.K1){this.key_1_count++}if(keyPress.K2){this.key_2_count++}if(keyPress.M1){this.key_3_count++}if(keyPress.M2){this.key_4_count++}this.lasthit_id=keyPress.ID}}else{break}}this.keypress_1_Text.text=this.key_1_count>0&&this.key_1_count.toString()||"K1";this.keypress_2_Text.text=this.key_2_count>0&&this.key_2_count.toString()||"K2";this.keypress_3_Text.text=this.key_3_count>0&&this.key_3_count.toString()||"M1";this.keypress_4_Text.text=this.key_4_count>0&&this.key_4_count.toString()||"M2";this.date_started=Date.now()-t;this.curMapTime=t;this.paused=false;osu.audio.music.play()},game_loop:function game_loop(){if(!this.paused){if(this.paused_time>0){this.date_started+=Date.now()-this.paused_time;this.paused_time=0}this.render_replay_frame();this.renderKeyPress();if(!this.has_started&&this.audioLeadIn==0&&!this.finished){if(this.is_doubletime)osu.audio.music.set_playback_speed(1.5);osu.audio.music.start();this.date_started=Date.now();this.has_started=true}else{if(!this.countdown_started){var self=this;this.date_started=Date.now();setTimeout(function(){self.audioLeadIn=0},this.audioLeadIn);this.countdown_started=true}var curTime=Date.now()-this.date_started-this.paused_time;this.update_timer_percentage(curTime/this.audioLeadIn,osu.helpers.constants.TIMER_INTRO_COLOUR)}var time=Date.now();if(this.has_started){this.curMapTime=time-this.date_started;this.paused_time=0;if(this.skipTime==-1||this.skipTime>-1&&this.skipTime<this.curMapTime){this.skip_container.visible=false}else{this.update_timer_percentage(this.curMapTime/this.skipTime,osu.helpers.constants.TIMER_INTRO_COLOUR);this.skip_container.visible=true}this.render_object()}}if(!this.finished)setTimeout(this.game_loop.bind(this),1)}};var osu=osu||{};osu.game=osu.game||{};osu.game.Perforamnce=function(){function Performance(difficultyRating,modMulti,hpDrain){_classCallCheck(this,Performance);this.combo=0;this.score=0;this.lifebar=1;this._difficultyRating=difficultyRating;this._modMulti=modMulti;this.totalHits=0;this.h300=0;this.h100=0;this.h50=0;this.hMiss=0;this.accuracy=1}_createClass(Performance,[{key:"add300",value:function add300(){this.h300++;this.addPoints(300)}},{key:"add100",value:function add100(){this.h100++;this.addPoints(100)}},{key:"add50",value:function add50(){this.h50++;this.addPoints(50)}},{key:"addMiss",value:function addMiss(){this.hMiss++;console.log("ayy");this.resetCombo()}},{key:"addPoints",value:function addPoints(p){this.score+=Math.round(p+p*(this.combo*this._difficultyRating*this._modMulti)/25);this.accuracy=osu.score.getAccuracy(this.h300,this.h100,this.h50,this.hMiss);this.combo++}},{key:"resetCombo",value:function resetCombo(){if(this.combo>10){osu.audio.sound.play_sound(osu.audio.sound.COMBOBREAK)}this.combo=0;this.accuracy=osu.score.getAccuracy(this.h300,this.h100,this.h50,this.hMiss)}}]);return Performance}();var osu=osu||{};osu.ui=osu.ui||{};osu.ui.interface=osu.ui.interface||{};osu.ui.interface.scorescreen={replayStarted:false,background:"",made_by:"",played_by:"",date_played:"",total_score:0,t300Hits:0,t300gHits:0,t100Hits:0,t100kHits:0,t50Hits:0,tMissHits:0,maxCombo:0,accuracy:"0.00",grade:"",mods:[],beatmap:{},master_container:new PIXI.Container,loading:false,getRenderWidth:function getRenderWidth(){return osu.ui.renderer.renderWidth},getRenderHeight:function getRenderHeight(){return osu.ui.renderer.renderHeight},map_details_heading_style:{font:Math.round((osu.ui.renderer.renderHeight+osu.ui.renderer.renderWidth)/100).toString()+"px Lucida Sans Unicode",fill:"#FFFFFF"},map_details_style:{font:Math.round((osu.ui.renderer.renderHeight+osu.ui.renderer.renderWidth)/150).toString()+"px Lucida Sans Unicode",fill:"#FFFFFF"},score_font_style:{font:"bold "+Math.round((osu.ui.renderer.renderHeight+osu.ui.renderer.renderWidth)/32).toString()+"px  Lucida Sans Unicode",fill:"#FFFFFF"},create_background_container:function create_background_container(){this.beatmap.background=this.beatmap.background||"";var background=PIXI.Texture.fromImage(this.beatmap.background);var background_sprite=new PIXI.Sprite(background);background_sprite.width=this.getRenderWidth();background_sprite.height=this.getRenderHeight();this.master_container.addChild(background_sprite);var background_dimmer=new PIXI.Graphics;background_dimmer.beginFill(0,0.5);background_dimmer.drawRect(0,0,this.getRenderWidth(),this.getRenderHeight());this.master_container.addChild(background_dimmer)},create_map_details_container:function create_map_details_container(){var map_details_area=new PIXI.Graphics;map_details_area.beginFill(0,0.8);map_details_area.drawRect(0,0,this.getRenderWidth(),this.getRenderHeight()*0.13);map_details_area.lineStyle(this.getRenderHeight()*0.006,15132390,1);map_details_area.drawRect(0,this.getRenderHeight()*0.13,this.getRenderWidth(),1);this.map_name_text=new PIXI.Text(this.beatmap.map_name,this.map_details_heading_style);this.map_name_text.x=5;this.map_name_text.y=this.getRenderHeight()*0.01;this.map_made_by=new PIXI.Text("Beatmap by "+this.beatmap.author,this.map_details_style);this.map_made_by.x=5;this.map_made_by.y=this.map_name_text.y+this.getRenderHeight()*0.04;this.map_played_by=new PIXI.Text("Played by "+this.played_by+" on "+this.date_played+".",this.map_details_style);this.map_played_by.x=5;this.map_played_by.y=this.map_made_by.y+this.getRenderHeight()*0.03;this.master_container.addChild(map_details_area);this.master_container.addChild(this.map_name_text);this.master_container.addChild(this.map_made_by);this.master_container.addChild(this.map_played_by)},create_total_score_details_container:function create_total_score_details_container(){var scoreBox=new PIXI.Graphics;scoreBox.beginFill(0,0.7);scoreBox.lineStyle(5,16777215,1);scoreBox.drawRect(this.getRenderWidth()*0.015,this.getRenderHeight()*0.15,this.getRenderWidth()*0.46,this.getRenderHeight()*0.1);var scoreLabel=new PIXI.Text("Score",this.map_details_heading_style);scoreLabel.x=this.getRenderWidth()*0.02;scoreLabel.y=this.getRenderHeight()*0.215;this.totalScoreText=new PIXI.Text(this.total_score.toString(),this.score_font_style);this.totalScoreText.x=this.getRenderWidth()*0.3;this.totalScoreText.y=this.getRenderHeight()*0.2;this.totalScoreText.anchor.set(0.5);this.master_container.addChild(scoreBox);this.master_container.addChild(scoreLabel);this.master_container.addChild(this.totalScoreText)},create_hit300_details_container:function create_hit300_details_container(){var scoreBox300=new PIXI.Graphics;scoreBox300.beginFill(0,0.7);scoreBox300.lineStyle(5,16777215,1);scoreBox300.drawRect(this.getRenderWidth()*0.015,this.getRenderHeight()*0.3,this.getRenderWidth()*0.46,this.getRenderHeight()*0.1);this.total300hitsText=new PIXI.Text(this.t300Hits.toString()+"x",this.score_font_style);this.total300hitsText.x=this.getRenderWidth()*0.16;this.total300hitsText.y=this.getRenderHeight()*0.35;this.total300hitsText.anchor.set(0.5);this.total300ghitsText=new PIXI.Text(this.t300gHits.toString()+"x",this.score_font_style);this.total300ghitsText.x=this.getRenderWidth()*0.39;this.total300ghitsText.y=this.getRenderHeight()*0.35;this.total300ghitsText.anchor.set(0.5);var hit300png=osu.skins.resources.hit300.texture;var hit300gpng=osu.skins.resources.hit300g.texture;var hit300Sprite=new PIXI.Sprite(hit300png);var hit300gSprite=new PIXI.Sprite(hit300gpng);hit300Sprite.position.x=this.getRenderWidth()*0.05;hit300Sprite.position.y=this.getRenderHeight()*0.35;hit300Sprite.width=this.getRenderWidth()*0.05;hit300Sprite.height=this.getRenderHeight()*0.09;hit300Sprite.anchor.set(0.5);hit300gSprite.position.x=this.getRenderWidth()*0.29;hit300gSprite.position.y=this.getRenderHeight()*0.35;hit300gSprite.width=this.getRenderWidth()*0.05;hit300gSprite.height=this.getRenderHeight()*0.09;hit300gSprite.anchor.set(0.5);this.master_container.addChild(scoreBox300);this.master_container.addChild(this.total300hitsText);this.master_container.addChild(this.total300ghitsText);this.master_container.addChild(hit300Sprite);this.master_container.addChild(hit300gSprite)},create_hit100_details_container:function create_hit100_details_container(){var scoreBox100=new PIXI.Graphics;scoreBox100.beginFill(0,0.7);scoreBox100.lineStyle(5,16777215,1);scoreBox100.drawRect(this.getRenderWidth()*0.015,this.getRenderHeight()*0.43,this.getRenderWidth()*0.46,this.getRenderHeight()*0.1);this.total100hitsText=new PIXI.Text(this.t100Hits.toString()+"x",this.score_font_style);this.total100hitsText.x=this.getRenderWidth()*0.16;this.total100hitsText.y=this.getRenderHeight()*0.48;this.total100hitsText.anchor.set(0.5);this.total100khitsText=new PIXI.Text(this.t100kHits.toString()+"x",this.score_font_style);this.total100khitsText.x=this.getRenderWidth()*0.39;this.total100khitsText.y=this.getRenderHeight()*0.48;this.total100khitsText.anchor.set(0.5);var hit100png=osu.skins.resources.hit100.texture;var hit100kpng=osu.skins.resources.hit100k.texture;var hit100Sprite=new PIXI.Sprite(hit100png);var hit100kSprite=new PIXI.Sprite(hit100kpng);hit100Sprite.position.x=this.getRenderWidth()*0.05;hit100Sprite.position.y=this.getRenderHeight()*0.48;hit100Sprite.width=this.getRenderWidth()*0.05;hit100Sprite.height=this.getRenderHeight()*0.09;hit100Sprite.anchor.set(0.5);hit100kSprite.position.x=this.getRenderWidth()*0.29;hit100kSprite.position.y=this.getRenderHeight()*0.48;hit100kSprite.width=this.getRenderWidth()*0.05;hit100kSprite.height=this.getRenderHeight()*0.09;hit100kSprite.anchor.set(0.5);this.master_container.addChild(scoreBox100);this.master_container.addChild(this.total100hitsText);this.master_container.addChild(this.total100khitsText);this.master_container.addChild(hit100Sprite);this.master_container.addChild(hit100kSprite)},create_hit50Misses_details_container:function create_hit50Misses_details_container(){var container=new PIXI.Container;var scoreBox50=new PIXI.Graphics;scoreBox50.beginFill(0,0.7);scoreBox50.lineStyle(5,16777215,1);scoreBox50.drawRect(this.getRenderWidth()*0.015,this.getRenderHeight()*0.56,this.getRenderWidth()*0.46,this.getRenderHeight()*0.1);this.total50hitsText=new PIXI.Text(this.t50Hits.toString()+"x",this.score_font_style);this.total50hitsText.x=this.getRenderWidth()*0.16;this.total50hitsText.y=this.getRenderHeight()*0.61;this.total50hitsText.anchor.set(0.5);this.totalMissesText=new PIXI.Text(this.tMissHits.toString()+"x",this.score_font_style);this.totalMissesText.x=this.getRenderWidth()*0.39;this.totalMissesText.y=this.getRenderHeight()*0.61;this.totalMissesText.anchor.set(0.5);var hit50png=osu.skins.resources.hit50.texture;var hit0png=osu.skins.resources.hit0.texture;var hit50Sprite=new PIXI.Sprite(hit50png);var hit0Sprite=new PIXI.Sprite(hit0png);hit50Sprite.position.x=this.getRenderWidth()*0.05;hit50Sprite.position.y=this.getRenderHeight()*0.61;hit50Sprite.width=this.getRenderWidth()*0.05;hit50Sprite.height=this.getRenderHeight()*0.09;hit50Sprite.anchor.set(0.5);hit0Sprite.position.x=this.getRenderWidth()*0.29;hit0Sprite.position.y=this.getRenderHeight()*0.61;hit0Sprite.width=this.getRenderWidth()*0.05;hit0Sprite.height=this.getRenderHeight()*0.09;hit0Sprite.anchor.set(0.5);this.master_container.addChild(scoreBox50);this.master_container.addChild(this.total50hitsText);this.master_container.addChild(this.totalMissesText);this.master_container.addChild(hit50Sprite);this.master_container.addChild(hit0Sprite)},create_combo_accuracy_details_container:function create_combo_accuracy_details_container(){var scoreBoxCombo=new PIXI.Graphics;var maxComboLabel=new PIXI.Text("Max Combo",this.map_details_heading_style);maxComboLabel.x=this.getRenderWidth()*0.02;maxComboLabel.y=this.getRenderHeight()*0.68;var accuracyLabel=new PIXI.Text("Accuracy",this.map_details_heading_style);accuracyLabel.x=this.getRenderWidth()*0.3;accuracyLabel.y=this.getRenderHeight()*0.68;this.maxComboText=new PIXI.Text(this.maxCombo.toString()+"x",this.score_font_style);this.maxComboText.x=this.getRenderWidth()*0.02;this.maxComboText.y=this.getRenderHeight()*0.705;this.accuracyText=new PIXI.Text(this.accuracy+"%",this.score_font_style);this.accuracyText.x=this.getRenderWidth()*0.27;this.accuracyText.y=this.getRenderHeight()*0.705;scoreBoxCombo.beginFill(0,0.7);scoreBoxCombo.lineStyle(5,16777215,1);scoreBoxCombo.drawRect(this.getRenderWidth()*0.015,this.getRenderHeight()*0.71,this.getRenderWidth()*0.46,this.getRenderHeight()*0.1);this.master_container.addChild(maxComboLabel);this.master_container.addChild(accuracyLabel);this.master_container.addChild(scoreBoxCombo);this.master_container.addChild(this.maxComboText);this.master_container.addChild(this.accuracyText)},create_grade_details_container:function create_grade_details_container(){var gradepng=osu.skins.resources[osu.score.GRADES[this.grade].large_icn].texture;var gradeSprite=new PIXI.Sprite(gradepng);gradeSprite.position.x=this.getRenderWidth()*0.8;gradeSprite.position.y=this.getRenderHeight()*0.4;gradeSprite.width=this.getRenderWidth()*0.3;gradeSprite.height=this.getRenderHeight()*0.5;gradeSprite.anchor.set(0.5);var replaypng=osu.skins.resources.pause_replay.texture;var replay_Sprite=new PIXI.Sprite(replaypng);replay_Sprite.position.x=this.getRenderWidth()*0.8;replay_Sprite.position.y=this.getRenderHeight()*0.8;replay_Sprite.width=this.getRenderWidth()*0.2;replay_Sprite.height=this.getRenderHeight()*0.2;replay_Sprite.anchor.set(0.5);replay_Sprite.interactive=true;replay_Sprite.on("mouseup",this.start_replay.bind(this));replay_Sprite.on("touchend",this.start_replay.bind(this));var backFrames=[];if(osu.skins.resources.menu_back_0){for(var i=0;i<99;i++){if(osu.skins.resources["menu_back_"+i]){backFrames.push(osu.skins.resources["menu_back_"+i].texture)}else{break}}}else{backFrames.push(osu.skins.resources.menu_back.texture)}var backAnimation=new PIXI.extras.MovieClip(backFrames);backAnimation.position.x=this.getRenderWidth()*0.05;backAnimation.position.y=this.getRenderHeight()-50;backAnimation.interactive=true;backAnimation.anchor.set(0.5,1);backAnimation.on("mouseup",this.exit.bind(this));backAnimation.on("touchend",this.exit.bind(this));backAnimation.animationSpeed=0.1;backAnimation.play();this.master_container.addChild(gradeSprite);for(i=0;i<this.mods.length;i++){if(this.mods[i].icon!=""){var modpng=osu.skins.resources[this.mods[i].icon].texture;var modSprite=new PIXI.Sprite(modpng);modSprite.position.y=this.getRenderHeight()*0.7;modSprite.position.x=this.getRenderWidth()*0.9-i*50;modSprite.anchor.set(0.5);this.master_container.addChild(modSprite)}}this.master_container.addChild(replay_Sprite);this.master_container.addChild(backAnimation)},exit:function exit(){osu.audio.sound.play_sound(osu.audio.sound.MENUBACK);osu.ui.interface.mainscreen.show_main_screen()},start_replay:function start_replay(){var self=this;if(osu.audio.music.__audio.readyState!=4&&osu.audio.music.__audio.src!=""&&!osu.audio.music.__audio.error){setTimeout(function(){if(!self.loading){osu.audio.sound.play_sound(osu.audio.sound.MENUHIT);self.loading=new PNotify({title:"Loading song",type:"info",hide:false})}self.start_replay()},1000);return}if(self.loading){self.loading.remove()}else{osu.audio.sound.play_sound(osu.audio.sound.MENUHIT)}if(this.replayStarted)return;this.replayStarted=true;setTimeout(function(){osu.audio.music.preview_screen=false;osu.ui.interface.osugame.replay_data=replay.replayData;osu.ui.interface.osugame.beatmap=self.beatmap;osu.ui.interface.osugame.mods=self.mods;osu.ui.interface.osugame.replay_played_by_text="REPLAY MODE - Watching "+replay.playerName+" play "+self.beatmap.map_name;osu.ui.interface.osugame.initGame();osu.audio.music.stop();osu.ui.interface.osugame.game_loop()},2000)},create_master_container:function create_master_container(){this.master_container.removeChildren();this.create_background_container();this.create_map_details_container();this.create_total_score_details_container();this.create_hit300_details_container();this.create_hit100_details_container();this.create_hit50Misses_details_container();this.create_combo_accuracy_details_container();this.create_grade_details_container()},onRender:function onRender(){},renderScoreScreen:function renderScoreScreen(){osu.ui.interface.replaycontroller.bindEvents();osu.ui.interface.replaycontroller.showPlayIcon();osu.ui.interface.replaycontroller.set_position(0);osu.ui.interface.replaycontroller.set_duration(this.beatmap.map_data.time_length+2000);osu.ui.interface.replaycontroller.disable_progressbar();osu.ui.interface.replaycontroller.showBar();this.$footer=osu.ui.interface.mainscreen.$footer||$("#footer");this.$footer.attr("style","");this.$footer.css("display","none");this.replayStarted=false;osu.ui.renderer.fixed_aspect=false;osu.ui.renderer.start();this.create_master_container();osu.ui.renderer.clearStage();osu.ui.renderer.addChild(this.master_container);var $replayURL=$("#replay_url");$replayURL.val("");$.ajax({url:APIURL+"replays",type:"GET",data:{"replay_id":replay.b64md5sum,"validate_only":true},dataType:"json",success:function success(data){if(data){if(data.status!="error"){$replayURL.val(window.location.href.split("?")[0]+"?r="+data);window.history.pushState(data,"osu Replays","?r="+data)}}}});osu.audio.music.init(this.beatmap.song,this.beatmap.song_md5sum);osu.audio.music.preview_screen=true;if(osu.audio.music.__audio.readyState!=4&&(osu.audio.music.__audio.src!=""||!osu.audio.music.__audio.error)){osu.audio.music.set_position(0);osu.audio.music.preview_screen=false}osu.audio.music.preview_time=this.beatmap.map_data.general.PreviewTime/1000;osu.audio.music.start();document.getElementById("replay_url_area").className="";document.getElementById("open_config_button_other").className=""}};osu=osu||{};osu.webapi=osu.webapi||{};osu.webapi.audio={findAudio:function findAudio(beatmap,callback,checkedLocal,checkLocalStatus){var songFound=false;if(!osu.settings.SETTINGS.asset_server&&!osu.settings.SETTINGS.song_url){callback(beatmap)}if(!checkedLocal&&osu.settings.SETTINGS.asset_server){var a=new Audio;var song=osu.settings.SETTINGS.asset_server+"/"+beatmap.song_md5sum;a.src=song;a.onloadedmetadata=function(){osu.webapi.audio.findAudio(beatmap,callback,true,true)};a.onerror=function(){osu.webapi.audio.findAudio(beatmap,callback,true,false)};return}if(checkedLocal){if(checkLocalStatus){songFound=true;beatmap.song=osu.settings.SETTINGS.asset_server+"/"+beatmap.song_md5sum;callback(beatmap)}}if(osu.settings.SETTINGS.song_url&&!(osu.settings.SETTINGS.asset_server&&checkedLocal&&songFound)){$.ajax({url:APIURL+"beatmaps",type:"GET",data:{id:beatmap.md5sum,validate_only:true},dataType:"json",success:function success(data){if(data){var beatmap_id=data.data.beatmap_id;beatmap.song=osu.settings.SETTINGS.song_url+"/"+beatmap_id;callback(beatmap)}}})}if(!osu.settings.SETTINGS.song_url&&!songFound){callback(beatmap)}}};osu=osu||{};osu.webapi=osu.webapi||{};osu.webapi.beatmaps={uploadBeatMap:function uploadBeatMap(beatmap){var beatmapFile=beatmap.data;var assets=beatmap.files;var beatmapMD5=beatmap.md5sum;$.ajax({url:APIURL+"beatmaps",type:"GET",data:{id:beatmapMD5,validate_only:true},dataType:"json",success:function success(data){if(data){}else{$.ajax({url:APIURL+"beatmaps",type:"POST",data:{beatmap:beatmapFile,assets:JSON.stringify(assets)},dataType:"json",success:function success(data){}})}}})},loadBeatMap:function loadBeatMap(id,callback){$.ajax({url:APIURL+"beatmaps",type:"GET",data:{id:id},dataType:"json",success:function success(data){if(data.status=="error"){callback(false);return}var beatmap={};beatmap.parsed=parse_osu_map_data(data.data.beatmap);var difficultyCalc=new osu.beatmaps.DifficultyCalculator(beatmap.parsed);beatmap.stars=difficultyCalc.calculate();for(var k in beatmap.parsed.metadata){beatmap[k.toLocaleLowerCase()]=beatmap.parsed.metadata[k]}var background_file_name=beatmap.parsed.events[0][2].replace(/"/g,"");beatmap.files=data.data.assets;for(var i=0;i<beatmap.files.length;i++){if(beatmap.files[i].filename==background_file_name){beatmap.background=beatmap.files[i].md5sum}if(beatmap.files[i].filename==beatmap.parsed.general.AudioFilename){beatmap.song=beatmap.files[i].md5sum}}beatmap.thumbnail="NOT_CALCULATED";beatmap.md5sum=id;database.insert_data(database.TABLES.BEATMAPS,beatmap.md5sum,beatmap,function(){callback(true)},function(){callback(true)})}})}};osu=osu||{};osu.webapi=osu.webapi||{};osu.webapi.replays={uploadReplay:function uploadReplay(file,base64md5){var formData=new FormData;formData.append("replay",file);$.ajax({url:APIURL+"replays",type:"GET",data:{"replay_id":base64md5,"validate_only":true},dataType:"json",success:function success(data){if(!data){$.ajax({url:APIURL+"replays",type:"POST",data:formData,processData:false,contentType:false,success:function success(data){}})}}})},loadReplay:function loadReplay(id){var _base64ToUint8Array=function _base64ToUint8Array(base64){var binary_string=window.atob(base64);var len=binary_string.length;var bytes=new Uint8Array(len);for(var i=0;i<len;i++){bytes[i]=binary_string.charCodeAt(i)}return bytes};$.ajax({url:APIURL+"replays",type:"GET",data:{"replay_id":id},dataType:"json",success:function success(data){if(data.status=="success"){ReplayParser(_base64ToUint8Array(data.data),function(replay_data){replay=replay_data;loadBeatMap()})}else{new PNotify({title:"Replay not found",text:data.msg,type:"error"})}}})}};if(!window.indexedDB){console.log("no index db = no storage ")}else{database.init(function(){osu.settings.onloaded=function(){osu.skins.init();osu.skins.onloaded=function(){osu.ui.interface.mainscreen.init();if(window.location.href.match(/\?./)){var queryDict={};location.search.substr(1).split("&").forEach(function(item){queryDict[item.split("=")[0]]=item.split("=")[1]});console.log(queryDict);if(queryDict.r){osu.webapi.replays.loadReplay(queryDict.r)}}}};osu.settings.init()})}
//# sourceMappingURL=osureplay.js.map
